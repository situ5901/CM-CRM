<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <!-- Date Range Picker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        #popup {
            display: none;
            /* Initially hidden */
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: red;
            /* Green background */
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }


        /* Modal styling */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            z-index: 1000;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .download-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: orange;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #table-view-btn {
            margin-left: 10px;
        }

        .popmodel {
            display: flex;
            text-align: center;
        }

        .hone {
            width: 50%;
        }

        .htwo {
            width: 50%;
        }
        .success-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border-radius: 5px;
        font-size: 16px;
        display: none;
        z-index: 9999;
    }

    /* Loading indicator styling */
    .loading-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 5px;
        display: none;
        z-index: 10000;
    }

    .download-link {
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
    }

    .download-link:hover {
        color: #0056b3;
    }

    #check-duplicates-btn, #duplicate-btn {
        padding: 8px 15px;
        margin: 0 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    #check-duplicates-btn {
        background-color: #17a2b8;
        color: white;
    }

    #duplicate-btn {
        background-color: #ffc107;
        color: black;
    }

    #duplicateModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 1200px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    #duplicate-table {
        width: 100%;
    }

    #duplicate-table td {
        vertical-align: top;
        padding: 8px;
    }

    #duplicate-table .details-cell {
        max-height: 200px;
        overflow-y: auto;
    }

    #duplicateModal .modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 95%;
        max-width: 1400px;
        max-height: 90vh;
        overflow-y: auto;
    }

    #duplicate-table {
        width: 100%;
        margin-top: 15px;
    }

    #duplicate-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    #duplicate-table td {
        vertical-align: top;
        padding: 12px;
    }

    #duplicate-table td:nth-child(2) {
        text-align: center;
    }

    .details-cell {
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff;
        border-radius: 4px;
    }

    /* Style for the export buttons */
    .dt-buttons {
        margin-bottom: 15px;
    }

    .dt-button {
        padding: 6px 12px;
        margin-right: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
    }

    .dt-button:hover {
        background-color: #f0f0f0;
    }

    #download-duplicates-btn {
        background-color: #4CAF50;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 20px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    #download-duplicates-btn:hover {
        background-color: #45a049;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }

    #download-duplicates-btn {
        background-color: #28a745;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-left: 10px;
    }

    #download-duplicates-btn:hover {
        background-color: #218838;
    }

    #download-duplicates-btn i {
        font-size: 16px;
    }

    #summary-table thead th:first-child {
        cursor: pointer;
        position: relative;
    }

    #summary-table thead th:first-child:after {
        content: '↕';
        position: absolute;
        right: 8px;
        opacity: 0.5;
    }

    #summary-table thead th:first-child.sorting_asc:after {
        content: '↑';
        opacity: 1;
    }

    #summary-table thead th:first-child.sorting_desc:after {
        content: '↓';
        opacity: 1;
    }

    .sortable {
        cursor: pointer;
        position: relative;
    }
    
    .sortable:hover {
        background-color: #f5f5f5;
    }
    
    .sort-asc::after {
        content: ' ↑';
    }
    
    .sort-desc::after {
        content: ' ↓';
    }

    .highlight-duplicate {
        animation: highlight 1s ease-in-out;
    }

    @keyframes highlight {
        0% { background-color: #ffeb3b; }
        100% { background-color: transparent; }
    }

    #check-duplicates {
        margin: 10px;
        padding: 8px 15px;
    }

    #duplicate-count {
        font-weight: bold;
    }

    /* Animation for highlighting */
    @keyframes highlightFade {
        from { background-color: #ffebee; }
        to { background-color: transparent; }
    }

    .highlight-duplicate {
        animation: highlightFade 2s ease-in-out;
    }

    .duplicate-highlight {
        background-color: #ffe6e6 !important;
        color: red !important;
        font-weight: bold !important;
    }

    #check-duplicates {
        margin: 10px;
        padding: 8px 15px;
    }

    #duplicate-count {
        font-weight: bold;
    }

    .chart-control {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 150px;
    }
    
    .visualization-section {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-top: 30px;
    }
    
    canvas {
        background-color: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .chart-control {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 180px;
        background-color: white;
    }

    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .chart-wrapper {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .download-chart-btn {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .download-chart-btn:hover {
        background-color: #45a049;
    }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    canvas {
        width: 100% !important;
        max-height: 400px;
    }




    .content{
        background-color: white;
        width: 100%;
    }


    .vertical-nav {
        width: 210px;
        background: #2c3e50;
        padding: 30px 0;
        border-radius: 10px;
    }

    .vertical-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .vertical-nav li {
        margin: 0;
        padding: 0;
    }

    .vertical-nav a {
        display: flex;
        align-items: center;
        padding: 15px 25px;
        color: #ecf0f1;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .vertical-nav a:hover {
        background: #34495e;
        padding-left: 30px;
    }

    .vertical-nav i {
        margin-right: 15px;
        width: 20px;
        text-align: center;
    }

    .vertical-nav span {
        font-size: 16px;
    }

    /* Active link styling */
    .vertical-nav a.active {
        background: #3498db;
        border-left: 4px solid #2980b9;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .vertical-nav {
            width: 100%;
        }
        
        .vertical-nav span {
            display: none;
        }
        
        .vertical-nav a {
            justify-content: center;
            padding: 15px;
        }
        
        .vertical-nav i {
            margin: 0;
            font-size: 20px;
        }
    }
    .secContent{
        border-top-left-radius: 25px;
        padding: 20px;
        background-color: #012141;
        width: 25%;
        justify-content: center;
        
    }

    .content-box{
        width: 100%;
    }
    .container{
        width: 100%;
        display: flex; /* Add display flex to enable proper layout */
        padding: 0; /* Remove any padding that might affect full width */
        margin: 0; /* Remove any margins that might affect full width */
         /* Ensure padding doesn't add to width */
    }
    .containers{
        display: flex;
        width: 100%;
        flex: 1; /* Allow content to take remaining space */
        padding: 20px; /* Add padding inside the content area instead */
    }

    .data-table {
        margin: 20px 0;
        overflow-x: auto;
    }

    #data-table {
        width: 100% !important;
        border-collapse: collapse;
    }

    #data-table th,
    #data-table td {
        padding: 12px 8px;
        white-space: nowrap;
    }

    #data-table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .dataTables_wrapper {
        width: 100%;
        margin: 0 auto;
    }

    /* Fix container width issues */
    .content-box {
        width: 100%;
        padding: 20px;
       
    }

    .containers {
        display: flex;
        width: 100%;
        
        box-sizing: border-box;
    }

    /* Adjust sidebar width */
    .secContent {
        width: 250px;
        flex-shrink: 0;
    }

    /* Make main content area flexible */
    .content-box {
        flex: 1;
        min-width: 0; /* Prevent content from overflowing */
    }

    #entries-dropdown {
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
    }

    #entries-dropdown:focus {
        outline: none;
        border-color: #4CAF50;
    }

    #duplicate-popup .modal-content {
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #duplicate-popup .ok-button:hover {
        background-color: #45a049;
    }

    #view-duplicates-link:hover {
        text-decoration: underline;
    }

    /* Responsive Layout Containers */
    .containers {
        display: flex;
        width: 100%;
        flex-direction: row;
        padding: 0;
        margin: 0;
        overflow-x: hidden;
    }

    @media (max-width: 768px) {
        .containers {
            flex-direction: column;
        }
    }

    /* Sidebar */
    .secContent {
        min-width: 250px;
        max-width: 250px;
        background-color: #012141;
        padding: 20px;
        transition: all 0.3s;
    }

    @media (max-width: 768px) {
        .secContent {
            min-width: 100%;
            max-width: 100%;
        }
        
        .vertical-nav {
            width: 100%;
        }
    }

    /* Main Content Area */
    .content {
        flex: 1;
        padding: 20px;
        min-width: 0; /* Prevents content overflow */
    }

    /* Table Responsiveness */
    .data-table {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    #data-table {
        min-width: 800px; /* Minimum width to prevent squishing */
    }

    /* Filter Controls */
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }

    .filters > div {
        flex: 1 1 200px;
        min-width: 200px;
    }

    /* Charts Container */
    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    @media (max-width: 640px) {
        .charts-container {
            grid-template-columns: 1fr;
        }
    }

    /* Modal Responsiveness */
    .modal-content {
        width: 95%;
        max-width: 1200px;
        margin: 20px auto;
        padding: 15px;
    }

    @media (max-width: 768px) {
        .modal-content {
            width: 98%;
            padding: 10px;
            margin: 10px auto;
        }
    }

    /* Button and Control Responsiveness */
    button, select, input {
        padding: 8px 12px;
        margin: 5px;
        min-height: 35px;
    }

    @media (max-width: 480px) {
        button, select, input {
            width: 100%;
            margin: 5px 0;
        }
        
        #dynamic-dropdowns > div {
            flex-direction: column;
            align-items: stretch;
        }
        
        #dynamic-dropdowns select {
            margin: 5px 0;
        }
    }

    /* Duplicate Modal Responsiveness */
    #duplicate-table {
        width: 100%;
        overflow-x: auto;
    }

    @media (max-width: 768px) {
        #duplicate-table td {
            min-width: 120px;
        }
        
        .details-cell {
            max-width: 200px;
            overflow-x: auto;
        }
    }

    /* Success and Loading Popups */
    .success-popup, .loading-popup {
        max-width: 90%;
        word-wrap: break-word;
    }

    /* Font Size Adjustments */
    @media (max-width: 480px) {
        body {
            font-size: 14px;
        }
        
        h1 {
            font-size: 1.5em;
        }
        
        h2 {
            font-size: 1.3em;
        }
    }
</style>
</head>

<body>
    <div class="containers">

        <!-- Sidebar content... -->
    <!-- Sidebar content... -->
    <div class="secContent">
        <div class="navbarsec">
            <h1 style="color: white;text-align: center;">Hello, {{ username }}</h1>
            <nav class="vertical-nav">
                <ul>
                    <li>
                        <a href="/home">
                            <i class="fas fa-home"></i>
                            <span>Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="/dashboard">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="/attendance">
                            <i class="fas fa-calendar-check"></i>
                            <span>Attendance</span>
                        </a>
                    </li>
                    <li>
                        <a href="/settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li>
                        <a href="/data_upload">
                            <i class="fas fa-upload"></i>
                            <span>Upload Data</span>
                        </a>
                    </li>
                    <li>
                        <a href="/logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>


        <!-- Main content area with shadow box -->
        <div class="content">
            <div class="content-box">
                <div class="welcome-message">Hello, {{ username }}</div>
                <h2>Dashboard</h2>

                <!-- Table View Button -->
                <button id="table-view-btn">Table View</button>
                <button id="updatePartnerBtn" class="btn btn-primary">Update Partner Info</button>
                <button id="allFieldsBtn" class="btn btn-primary">Save DB</button>

                <!-- Send Email Button -->
                
                <!-- <form method="POST" action="/dashboard">
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
                        Send Report via Email
                    </button>
                </form> -->


                <!-- <button id="send-email-button" class="btn btn-primary" style="margin-top: 20px;">
                    Send Email
                </button> -->
                
                <!-- Loading Indicator (hidden initially) -->
                <div id="loading-indicator" class="loading-popup" style="display: none;">
                    Sending Email...
                </div>
                
                <!-- Success popup div -->
                <div id="success-message" class="success-popup" style="display: none;">
                    Success!
                </div>


                <!-- Replace the existing email button and script with this updated version -->
                <button id="send-email-button" class="btn btn-primary" style="margin-top: 20px;">
                    Send Filtered Data via Email
                </button>

                <script>
                    document.getElementById('send-email-button').addEventListener('click', function () {
                        // Get the DataTable instance
                        const table = $('#data-table').DataTable();
                        
                        // Get filtered data
                        const filteredData = [];
                        table.rows({ filter: 'applied' }).every(function() {
                            const rowData = this.data();
                            filteredData.push({
                                'Phone': rowData[0],
                                'Disbursed Amount': rowData[1],
                                'Disbursal Date': rowData[2],
                                'Status': rowData[3],
                                'Lender': rowData[4],
                                'Created At': rowData[5],
                                'Partner': rowData[6]
                            });
                        });

                        // Show loading indicator
                        document.getElementById('loading-indicator').style.display = 'block';

                        // Send filtered data to server
                        fetch('/dashboard', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                filteredData: filteredData,
                                totalRecords: filteredData.length,
                                totalAmount: filteredData.reduce((sum, row) => sum + (parseFloat(row['Disbursed Amount']) || 0), 0)
                            })
                        })
                        .then(response => {
                            // Hide loading indicator
                            document.getElementById('loading-indicator').style.display = 'none';

                            if (response.ok) {
                                // Show success message
                                document.getElementById('success-message').style.display = 'block';
                                
                                // Hide success message after 3 seconds
                                setTimeout(function() {
                                    document.getElementById('success-message').style.display = 'none';
                                }, 3000);
                            } else {
                                response.text().then(text => alert(`Error sending email: ${text}`));
                            }
                        })
                        .catch(error => {
                            // Hide loading indicator and show error
                            document.getElementById('loading-indicator').style.display = 'none';
                            alert(`Error: ${error.message}`);
                        });
                    });
                </script>

                <!-- Add this to your existing modal email button as well -->
                <script>
                    document.getElementById('modal-send-email-button').addEventListener('click', function () {
                        // Get the summary table data
                        const summaryData = [];
                        $('#summary-tbody tr').each(function() {
                            const row = {};
                            $(this).find('td').each(function(index) {
                                const header = $('#summary-header th').eq(index).text();
                                row[header] = $(this).text();
                            });
                            summaryData.push(row);
                        });

                        // Show loading indicator
                        document.getElementById('loading-indicator').style.display = 'block';

                        // Send summary data to server
                        fetch('/dashboard', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                summaryData: summaryData,
                                viewType: $('#view-type').val(),
                                partnerFilter: $('#partner-filter').val()
                            })
                        })
                        .then(response => {
                            // Hide loading indicator
                            document.getElementById('loading-indicator').style.display = 'none';

                            if (response.ok) {
                                // Show success message
                                document.getElementById('success-message').style.display = 'block';
                                
                                // Hide success message after 3 seconds
                                setTimeout(function() {
                                    document.getElementById('success-message').style.display = 'none';
                                }, 3000);
                            } else {
                                response.text().then(text => alert(`Error sending email: ${text}`));
                            }
                        })
                        .catch(error => {
                            // Hide loading indicator and show error
                            document.getElementById('loading-indicator').style.display = 'none';
                            alert(`Error: ${error.message}`);
                        });
                    });
                </script>

                <!-- Plus Button to Add New Dropdowns -->
                <button id="add-dropdown-btn" style="margin-bottom: 20px;">+</button>

                <!-- Container for Dynamically Created Dropdowns -->
                <div id="dynamic-dropdowns" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>

                <!-- Lender, Month, Year, Date Range, and Created At Filters -->
                <div class="filters" style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                    <!-- Lender Dropdown -->
                    <div style="flex: 1;">
                        <label for="lender-dropdown">Select Lender:</label>
                        <select id="lender-dropdown" style="width: 100%;">
                            <option value="">All Lenders</option>
                            {% for lender in lender_options %}
                            <option value="{{ lender }}">{{ lender }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Month Dropdown -->
                    <div style="flex: 1;">
                        <label for="month-dropdown">Select Month:</label>
                        <select id="month-dropdown" style="width: 100%;">
                            <option value="">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>

                    <!-- Year Dropdown -->
                    <div style="flex: 1;">
                        <label for="year-dropdown">Select Year:</label>
                        <select id="year-dropdown" style="width: 100%;">
                            <option value="">All Years</option>
                            <!-- Populate years dynamically -->
                        </select>
                    </div>

                    <!-- Date Range Filter -->
                    <div style="flex: 1;">
                        <label for="date-range-filter">Select Date Range:</label>
                        <input type="text" id="date-range-filter" style="width: 100%;" placeholder="Select Date Range">
                    </div>

                    <!-- Created At Dropdown -->
                    <div style="flex: 1;">
                        <label for="created-at-dropdown">Select Created At:</label>
                        <select id="created-at-dropdown" style="width: 100%;">
                            <option value="">All Dates</option>
                            {% for created_at in created_at_options %}
                            <option value="{{ created_at }}">{{ created_at }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Partner Dropdown -->
                    <div style="flex: 1;">
                        <label for="partner-dropdown">Select Partner:</label>
                        <select id="partner-dropdown" style="width: 100%;">
                            <option value="">All Partners</option>
                            {% for partner in partner_options %}
                            <option value="{{ partner }}">{{ partner if partner != 'None' else 'None' }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Modal Popup for Table View -->
                <div id="table-view-modal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <button id="modal-send-email-button" class="download-button">Send Email</button>
                        <h3>Lender-wise Monthly Summary</h3>

                        <!-- Add view type dropdown -->
                        <div style="margin-bottom: 20px; display: flex; gap: 20px;">
                            <!-- Partner Filter dropdown -->
                            <div>
                                <label for="partner-filter">Partner Filter:</label>
                                <select id="partner-filter" style="margin-left: 10px;">
                                    <option value="">All Partners</option>
                                    <option value="MoneyTap">MoneyTap</option>
                                    <option value="MoneyView">DTMF</option>
                                    <option value="None">None</option>
                                    <option value="Zype_LS">Zype_LS</option>
                                </select>
                            </div>

                            <!-- View Type dropdown -->
                            <div>
                                <label for="view-type">View Type:</label>
                                <select id="view-type" style="margin-left: 10px;">
                                    <option value="count">Count</option>
                                    <option value="amount">Amount</option>
                                    <option value="payout">Payout (3%)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dynamic Summary Table Structure -->
                        <table id="summary-table" class="display" style="width:100%; margin-top: 20px;">
                            <thead>
                                <tr id="summary-header">
                                    <th class="sortable" data-sort="month">Month ↕</th>
                                    <!-- Lender columns will be added dynamically -->
                                    <th class="sortable" data-sort="total">Total ↕</th>
                                </tr>
                            </thead>
                            <tbody id="summary-tbody">
                                <!-- Rows will be inserted dynamically -->
                            </tbody>
                            <tfoot>
                                <tr id="summary-footer">
                                    <td>Total</td>
                                    <!-- Total cells will be added dynamically -->
                                </tr>
                            </tfoot>
                        </table>

                        <script>
                            document.getElementById('modal-send-email-button').addEventListener('click', function () {
                                // Get the summary table data
                                const summaryData = [];
                                $('#summary-tbody tr').each(function() {
                                    const row = {};
                                    $(this).find('td').each(function(index) {
                                        const header = $('#summary-header th').eq(index).text();
                                        row[header] = $(this).text();
                                    });
                                    summaryData.push(row);
                                });

                                // Show loading indicator
                                document.getElementById('loading-indicator').style.display = 'block';

                                // Send summary data to server
                                fetch('/dashboard', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ 
                                        summaryData: summaryData,
                                        viewType: $('#view-type').val(),
                                        partnerFilter: $('#partner-filter').val()
                                    })
                                })
                                .then(response => {
                                    // Hide loading indicator
                                    document.getElementById('loading-indicator').style.display = 'none';

                                    if (response.ok) {
                                        // Show success message
                                        document.getElementById('success-message').style.display = 'block';
                                        
                                        // Hide success message after 3 seconds
                                        setTimeout(function() {
                                            document.getElementById('success-message').style.display = 'none';
                                        }, 3000);
                                    } else {
                                        response.text().then(text => alert(`Error sending email: ${text}`));
                                    }
                                })
                                .catch(error => {
                                    // Hide loading indicator and show error
                                    document.getElementById('loading-indicator').style.display = 'none';
                                    alert(`Error: ${error.message}`);
                                });
                            });
                        </script>

                        <!-- Update the visualization section in the modal -->
                        <div class="visualization-section" style="margin-top: 30px;">
                            <h3>Data Visualization</h3>
                            
                            <!-- Enhanced controls for visualization -->
                            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                                <div class="chart-control-group">
                                    <label for="chart-type">Chart Type:</label>
                                    <select id="chart-type" class="chart-control">
                                        <option value="bar">Bar Chart</option>
                                        <option value="line">Line Chart</option>
                                        <option value="pie">Pie Chart</option>
                                        <option value="doughnut">Doughnut Chart</option>
                                        <option value="radar">Radar Chart</option>
                                        <option value="polarArea">Polar Area</option>
                                    </select>
                                </div>

                                <div class="chart-control-group">
                                    <label for="chart-data">Data View:</label>
                                    <select id="chart-data" class="chart-control">
                                        <option value="monthly">Monthly Trend</option>
                                        <option value="lender">Lender Distribution</option>
                                        <option value="status">Status Distribution</option>
                                        <option value="amount">Amount Distribution</option>
                                        <option value="partner">Partner Distribution</option>
                                    </select>
                                </div>

                                <div class="chart-control-group">
                                    <label for="time-period">Time Period:</label>
                                    <select id="time-period" class="chart-control">
                                        <option value="all">All Time</option>
                                        <option value="year">Last Year</option>
                                        <option value="6months">Last 6 Months</option>
                                        <option value="quarter">Last Quarter</option>
                                        <option value="month">Last Month</option>
                                    </select>
                                </div>

                                <div class="chart-control-group">
                                    <label for="value-type">Value Type:</label>
                                    <select id="value-type" class="chart-control">
                                        <option value="count">Count</option>
                                        <option value="amount">Amount</option>
                                        <option value="average">Average</option>
                                        <option value="payout">Payout (3%)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Chart containers with loading indicators -->
                            <div class="charts-container">
                                <div class="chart-wrapper">
                                    <div class="chart-header">
                                        <h4 id="main-chart-title">Primary Analysis</h4>
                                        <button class="download-chart-btn" data-chart="main">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                    <div class="loading-spinner main-chart-loader" style="display: none;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </div>
                                    <canvas id="mainChart"></canvas>
                                </div>

                                <div class="chart-wrapper">
                                    <div class="chart-header">
                                        <h4 id="trend-chart-title">Trend Analysis</h4>
                                        <button class="download-chart-btn" data-chart="trend">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                    <div class="loading-spinner trend-chart-loader" style="display: none;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </div>
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            

                <!-- jQuery, DataTables, and Date Range Picker JavaScript -->
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
                <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>


                <!-- Table with highlighted header -->
                <div class="data-table">
                    <table id="data-table" class="display">
                        <thead>
                            <tr>
                                <th style="background-color: #4CAF50;">Phone</th>
                                <th style="background-color: #4CAF50;">Disbursed Amount</th>
                                <th style="background-color: #4CAF50;">Disbursal Date</th>
                                <th style="background-color: #4CAF50;">Status</th>
                                <th style="background-color: #4CAF50;">Lender</th>
                                <th style="background-color: #4CAF50;">Created At</th>
                                <th style="background-color: #4CAF50;">Partner</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_data %}
                            <tr>
                                <td>{{ row.phone }}</td>
                                <td>{{ row.disbursedamount }}</td>
                                <td>{{ row.disbursaldate }}</td>
                                <td>{{ row.status }}</td>
                                <td>{{ row.Lender }}</td>
                                <td>{{ row.createdAt }}</td>
                                <td>{{ row.Partner }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td>Total:</td>
                                <td id="total-disbursed">{{ total_disbursed }}</td>
                                <td colspan="5" id="total-count">{{ total_count }} records</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Add this modal structure after your existing modals -->
                <div id="duplicateModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Duplicate Phone Numbers</h2>
                            <span class="close" id="closeDuplicateModal">&times;</span>
                            <button id="download-duplicates-btn">
                                <i class="fas fa-download"></i> Download CSV
                            </button>
                        </div>
                        <div class="modal-body">
                            <table id="duplicate-table" class="display">
                                <thead>
                                    <tr>
                                        <th>Phone Number</th>
                                        <th>Count</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Add these buttons after your existing buttons -->
                <button id="check-duplicates-btn">Check Duplicates</button>
                <button id="duplicate-btn">View Duplicates</button>

                <!-- Add this HTML structure after your existing modals -->
                <div id="duplicate-popup" class="modal" style="display: none;">
                    <div class="modal-content" style="background-color: #e8f5e9; max-width: 400px; text-align: center; padding: 30px;">
                        <p id="duplicate-count-message" style="font-size: 16px; margin-bottom: 15px;"></p>
                        <p style="font-size: 14px; margin-bottom: 20px;">
                            Click "<a href="#" id="view-duplicates-link" style="color: #4CAF50; text-decoration: none;">View Duplicates</a>" to see details.
                        </p>
                        <button class="ok-button" style="background-color: #4CAF50; color: white; border: none; padding: 10px 30px; border-radius: 4px; cursor: pointer;">OK</button>
                    </div>
                </div>

                <!-- Add this JavaScript after your existing scripts -->
                <script>
                $(document).ready(function() {
                    // Initialize duplicate table
                    const duplicateTable = $('#duplicate-table').DataTable({
                        pageLength: 25,
                        order: [[1, 'desc']],
                        dom: 'Bfrtip',
                        buttons: ['copy', 'csv', 'excel']
                    });

                    // Function to show duplicates modal
                    function showDuplicatesModal() {
                        duplicateTable.clear();
                        const phoneDetails = {};
                        
                        // First pass: collect all phone numbers and their occurrences
                        $('#data-table').DataTable().rows().every(function() {
                            const data = this.data();
                            const phone = data[0];
                            const amount = data[1];
                            const date = data[2];
                            const status = data[3];
                            const lender = data[4];
                            const createdAt = data[5];
                            const partner = data[6];
                            
                            if (!phoneDetails[phone]) {
                                phoneDetails[phone] = {
                                    count: 1,
                                    entries: [{
                                        amount: amount,
                                        date: date,
                                        status: status,
                                        lender: lender,
                                        createdAt: createdAt,
                                        partner: partner
                                    }]
                                };
                            } else {
                                phoneDetails[phone].count++;
                                phoneDetails[phone].entries.push({
                                    amount: amount,
                                    date: date,
                                    status: status,
                                    lender: lender,
                                    createdAt: createdAt,
                                    partner: partner
                                });
                            }
                        });

                        // Add entries with duplicates to the table
                        Object.entries(phoneDetails).forEach(([phone, details]) => {
                            if (details.count > 1) {
                                details.entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                                
                                const detailsHtml = details.entries.map((entry, index) => 
                                    `<div style="margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                        <strong>Entry ${index + 1}:</strong><br>
                                        <strong>Lender:</strong> ${entry.lender}<br>
                                        <strong>Date:</strong> ${entry.date}<br>
                                        <strong>Amount:</strong> ₹${parseFloat(entry.amount).toLocaleString('en-IN')}<br>
                                        <strong>Status:</strong> ${entry.status}<br>
                                        <strong>Created At:</strong> ${entry.createdAt}<br>
                                        <strong>Partner:</strong> ${entry.partner}
                                    </div>`
                                ).join('');

                                duplicateTable.row.add([
                                    `<span style="font-weight: bold;">${phone}</span>`,
                                    `<span style="color: red; font-weight: bold;">${details.count}</span>`,
                                    detailsHtml
                                ]);
                            }
                        });

                        duplicateTable.draw();
                        document.getElementById('duplicateModal').style.display = "block";

                        // Add summary information
                        const totalDuplicates = duplicateTable.rows().count();
                        const summaryHtml = `
                            <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                <strong>Total Duplicate Numbers Found:</strong> ${totalDuplicates}<br>
                            </div>
                        `;
                        
                        $('#duplicate-table_wrapper').before(summaryHtml);
                    }

                    // Event handlers
                    $('#duplicate-btn').on('click', showDuplicatesModal);
                    
                    $('#closeDuplicateModal').on('click', function() {
                        document.getElementById('duplicateModal').style.display = "none";
                    });

                    // Close modal when clicking outside
                    window.onclick = function(event) {
                        if (event.target == document.getElementById('duplicateModal')) {
                            document.getElementById('duplicateModal').style.display = "none";
                        }
                    }

                    // Download duplicates functionality
                    $('#download-duplicates-btn').on('click', function() {
                        try {
                            let csvData = [];
                            csvData.push(['Phone Number', 'Occurrences', 'Lender', 'Date', 'Amount', 'Status', 'Created At', 'Partner']);
                            
                            $('#duplicate-table tbody tr').each(function() {
                                const phone = $(this).find('td:first').text().trim();
                                const occurrences = $(this).find('td:nth-child(2)').text().trim();
                                const detailsCell = $(this).find('td:last');
                                
                                detailsCell.find('div').each(function() {
                                    const entryText = $(this).html();
                                    
                                    const lender = $(this).find('strong:contains("Lender:") + br').text().trim() ||
                                                 entryText.match(/Lender:\s*([^<\n]+)/)?.[1]?.trim() || '';
                                    const date = $(this).find('strong:contains("Date:") + br').text().trim() ||
                                                entryText.match(/Date:\s*([^<\n]+)/)?.[1]?.trim() || '';
                                    const amount = $(this).find('strong:contains("Amount:") + br').text().trim() ||
                                                 entryText.match(/Amount:\s*₹?([^<\n]+)/)?.[1]?.trim() || '';
                                    const status = $(this).find('strong:contains("Status:") + br').text().trim() ||
                                                 entryText.match(/Status:\s*([^<\n]+)/)?.[1]?.trim() || '';
                                    const createdAt = $(this).find('strong:contains("Created At:") + br').text().trim() ||
                                                    entryText.match(/Created At:\s*([^<\n]+)/)?.[1]?.trim() || '';
                                    const partner = $(this).find('strong:contains("Partner:") + br').text().trim() ||
                                                  entryText.match(/Partner:\s*([^<\n]+)/)?.[1]?.trim() || '';

                                    const cleanAmount = amount.replace(/[₹,]/g, '').trim();

                                    csvData.push([
                                        phone,
                                        occurrences,
                                        lender,
                                        date,
                                        cleanAmount,
                                        status,
                                        createdAt,
                                        partner
                                    ]);
                                });
                            });

                            const csvContent = csvData.map(row => 
                                row.map(cell => {
                                    if (cell === null || cell === undefined) return '""';
                                    const cellStr = String(cell);
                                    return cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n') 
                                        ? `"${cellStr.replace(/"/g, '""')}"` 
                                        : cellStr;
                                }).join(',')
                            ).join('\n');

                            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement('a');
                            const timestamp = new Date().toISOString().slice(0,10);
                            const filename = `duplicate_numbers_${timestamp}.csv`;
                            
                            if (navigator.msSaveBlob) {
                                navigator.msSaveBlob(blob, filename);
                            } else {
                                link.href = URL.createObjectURL(blob);
                                link.download = filename;
                                link.style.visibility = 'hidden';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(link.href);
                            }
                            
                            console.log('Download completed successfully');
                        } catch (error) {
                            console.error('Download error:', error);
                            alert('Error downloading file. Please check console for details.');
                        }
                    });

                    // Function to highlight duplicate phone numbers
                    $('#check-duplicates-btn').on('click', function() {
                        const table = $('#data-table').DataTable();
                        const phoneMap = new Map();
                        
                        // Reset previous highlighting
                        table.rows().every(function() {
                            $(this.node()).find('td:first').removeClass('duplicate-highlight');
                        });

                        // First pass: collect phone numbers from first column
                        table.rows().every(function() {
                            const phone = this.data()[0]?.toString().trim(); // Get first column (Phone)
                            
                            if (phone) {
                                if (phoneMap.has(phone)) {
                                    phoneMap.set(phone, phoneMap.get(phone) + 1);
                                } else {
                                    phoneMap.set(phone, 1);
                                }
                            }
                        });

                        // Second pass: highlight duplicates and count them
                        let duplicateCount = 0;
                        table.rows().every(function() {
                            const phone = this.data()[0]?.toString().trim();
                            
                            if (phone && phoneMap.get(phone) > 1) {
                                // Find and highlight the phone cell (first column)
                                const row = $(this.node());
                                const phoneCell = row.find('td:first');
                                
                                // Apply highlighting class
                                phoneCell.addClass('duplicate-highlight');
                                
                                // Add animation class
                                phoneCell.addClass('highlight-duplicate');
                                
                                // Remove animation class after animation completes
                                setTimeout(() => {
                                    phoneCell.removeClass('highlight-duplicate');
                                }, 2000);
                            }
                        });

                        // Count unique duplicate numbers
                        duplicateCount = Array.from(phoneMap.entries())
                            .filter(([_, count]) => count > 1).length;

                        if (duplicateCount > 0) {
                            // Show custom popup
                            $('#duplicate-message').text(`Found ${duplicateCount} phone numbers with duplicates.`);
                            $('#duplicate-popup').show();
                        } else {
                            $('#duplicate-message').text('No duplicate numbers found.');
                            $('#duplicate-popup').show();
                        }
                    });

                    // Add click handler for the View Duplicates link
                    $('#view-duplicates-link').on('click', function(e) {
                        e.preventDefault();
                        $('#duplicate-popup').hide();
                        $('#duplicate-btn').click(); // Trigger the View Duplicates button click
                    });

                    // Function to close the popup
                    function closeDuplicatePopup() {
                        $('#duplicate-popup').hide();
                    }

                    // Close popup when clicking outside
                    $(window).on('click', function(e) {
                        if ($(e.target).is('#duplicate-popup')) {
                            closeDuplicatePopup();
                        }
                    });
                });
                </script>

                <script>
                // Initialize chart variables
                let mainChart = null;
                let trendChart = null;

                // Update the updateCharts function to handle value type and time period filters
                function updateCharts() {
                    // Get filter values
                    const valueType = $('#value-type').val();
                    const timePeriod = $('#time-period').val();
                    
                    // Get the table data with applied filters
                    const summaryData = {};
                    const months = [];
                    const lenders = new Set();
                    
                    // Apply time period filter
                    const currentDate = new Date();
                    let startDate = new Date();
                    
                    switch(timePeriod) {
                        case 'month':
                            startDate.setMonth(currentDate.getMonth() - 1);
                            break;
                        case 'quarter':
                            startDate.setMonth(currentDate.getMonth() - 3);
                            break;
                        case '6months':
                            startDate.setMonth(currentDate.getMonth() - 6);
                            break;
                        case 'year':
                            startDate.setFullYear(currentDate.getFullYear() - 1);
                            break;
                        case 'all':
                        default:
                            startDate = new Date(0); // Beginning of time
                    }

                    // Collect data from the summary table with time period filter
                    $('#summary-tbody tr').each(function() {
                        const month = $(this).find('td:first').text();
                        const [monthName, year] = month.split('-');
                        const rowDate = new Date(year, getMonthNumber(monthName));
                        
                        // Skip if row date is before start date
                        if (rowDate < startDate) return;
                        
                        months.push(month);
                        
                        const rowData = {};
                        $(this).find('td').each(function(index) {
                            if (index > 0 && index < $(this).parent().find('td').length - 1) {
                                const lenderName = $('#summary-header th').eq(index).text();
                                lenders.add(lenderName);
                                
                                // Get value based on selected value type
                                let value = parseFloat($(this).text().replace(/[₹,]/g, '')) || 0;
                                switch(valueType) {
                                    case 'amount':
                                        // Value is already the amount
                                        break;
                                    case 'count':
                                        value = value > 0 ? 1 : 0; // Convert to count
                                        break;
                                    case 'average':
                                        // Calculate average if we have count data
                                        const count = $(this).data('count') || 1;
                                        value = value / count;
                                        break;
                                    case 'payout':
                                        value = value * 0.03; // Calculate 3% payout
                                        break;
                                }
                                
                                rowData[lenderName] = value;
                            }
                        });
                        summaryData[month] = rowData;
                    });

                    // Update charts with filtered data
                    if (mainChart) mainChart.destroy();
                    if (trendChart) trendChart.destroy();

                    // Create the main chart
                    const ctx = document.getElementById('mainChart').getContext('2d');
                    const chartType = $('#chart-type').val();

                    const datasets = Array.from(lenders).map(lender => ({
                        label: lender,
                        data: months.map(month => summaryData[month][lender] || 0),
                        backgroundColor: getColorForLender(lender),
                        borderWidth: 1
                    }));

                    mainChart = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: months,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { stacked: true },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: getYAxisLabel(valueType)
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: getChartTitle(valueType, timePeriod)
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });

                    // Create trend chart
                    const trendCtx = document.getElementById('trendChart').getContext('2d');
                    const monthlyTotals = months.map(month => {
                        return Object.values(summaryData[month]).reduce((sum, val) => sum + (val || 0), 0);
                    });

                    trendChart = new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: `${valueType.charAt(0).toUpperCase() + valueType.slice(1)} Trend`,
                                data: monthlyTotals,
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: getYAxisLabel(valueType)
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${timePeriod.charAt(0).toUpperCase() + timePeriod.slice(1)} Trend Analysis`
                                }
                            }
                        }
                    });
                }

                // Helper functions
                function getMonthNumber(monthName) {
                    const months = {
                        'January': 0, 'February': 1, 'March': 2, 'April': 3,
                        'May': 4, 'June': 5, 'July': 6, 'August': 7,
                        'September': 8, 'October': 9, 'November': 10, 'December': 11
                    };
                    return months[monthName];
                }

                function getYAxisLabel(valueType) {
                    switch(valueType) {
                        case 'amount':
                            return 'Amount (₹)';
                        case 'count':
                            return 'Number of Transactions';
                        case 'average':
                            return 'Average Amount (₹)';
                        case 'payout':
                            return 'Payout Amount (₹)';
                        default:
                            return '';
                    }
                }

                function getChartTitle(valueType, timePeriod) {
                    const valueTypeLabel = valueType.charAt(0).toUpperCase() + valueType.slice(1);
                    const timePeriodLabel = timePeriod.charAt(0).toUpperCase() + timePeriod.slice(1);
                    return `${valueTypeLabel} Distribution (${timePeriodLabel})`;
                }

                // Add event listeners for the filters
                $('#value-type, #time-period').on('change', updateCharts);

                // Helper function to get consistent colors for lenders
                function getColorForLender(lender) {
                    const colorMap = {
                        'MVCancel': '#4CAF50',
                        'MoneyView': '#2196F3',
                        'Mpokket': '#FFC107',
                        // Add more lenders and colors as needed
                    };
                    return colorMap[lender] || '#' + Math.floor(Math.random()*16777215).toString(16);
                }

                // Add event listeners for chart controls
                $('#chart-type, #chart-data').on('change', updateCharts);

                // Update charts when table view is opened
                $('#table-view-btn').on('click', function() {
                    setTimeout(updateCharts, 500);
                });

                // Initial chart update
                $(document).ready(function() {
                    // Add event listener for view type changes
                    $('#view-type').on('change', updateCharts);
                });
                </script>

                <!-- Add this after your existing DataTable initialization -->
                <script>
                $(document).ready(function() {
                    // Get the DataTable instance
                    const table = $('#data-table').DataTable({
                        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, 'All Data']], // Replace 100 with -1 and show "All Data" text
                        pageLength: 10 // Default page length
                    });
                    
                    // Counter for page length changes
                    let pageLengthChangeCount = 0;
                    
                    // Add event listener for page length changes
                    table.on('length.dt', function(e, settings, len) {
                        pageLengthChangeCount++;
                        
                        // On the 4th change, show all records
                        if (pageLengthChangeCount === 4) {
                            table.page.len(-1).draw(); // -1 shows all records
                            
                            // Optional: Disable the page length dropdown
                            $('.dataTables_length select').prop('disabled', true);
                            
                            // Optional: Add visual feedback
                            $('.dataTables_length').append(
                                '<span style="margin-left: 10px; color: green;">' +
                                '<i class="fas fa-check"></i> Showing all records</span>'
                            );
                        }
                    });
                });
                </script>
            </div>
        </div>

    </div>




    <!-- jQuery, DataTables, and Date Range Picker JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        function sendEmail() {
            // Collect selected data (modify this according to your data selection logic)
            const selectedData = getSelectedData(); // Implement this function to get selected data

            fetch('/send_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ data: selectedData }),
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    </script>
</body>

</html>

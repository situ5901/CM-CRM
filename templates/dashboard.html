<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <!-- Date Range Picker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        #popup {
            display: none;
            /* Initially hidden */
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: red;
            /* Green background */
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }


        /* Modal styling */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            z-index: 1000;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .download-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: orange;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #table-view-btn {
            margin-left: 10px;
        }

        .popmodel {
            display: flex;
            text-align: center;
        }

        .hone {
            width: 50%;
        }

        .htwo {
            width: 50%;
        }
        .success-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border-radius: 5px;
        font-size: 16px;
        display: none;
        z-index: 9999;
    }

    /* Loading indicator styling */
    .loading-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 5px;
        display: none;
        z-index: 10000;
    }

    .download-link {
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
    }

    .download-link:hover {
        color: #0056b3;
    }

    #check-duplicates-btn, #duplicate-btn {
        padding: 8px 15px;
        margin: 0 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    #check-duplicates-btn {
        background-color: #17a2b8;
        color: white;
    }

    #duplicate-btn {
        background-color: #ffc107;
        color: black;
    }

    #duplicateModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 1200px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    #duplicate-table {
        width: 100%;
    }

    #duplicate-table td {
        vertical-align: top;
        padding: 8px;
    }

    #duplicate-table .details-cell {
        max-height: 200px;
        overflow-y: auto;
    }

    #duplicateModal .modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 95%;
        max-width: 1400px;
        max-height: 90vh;
        overflow-y: auto;
    }

    #duplicate-table {
        width: 100%;
        margin-top: 15px;
    }

    #duplicate-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    #duplicate-table td {
        vertical-align: top;
        padding: 12px;
    }

    #duplicate-table td:nth-child(2) {
        text-align: center;
    }

    .details-cell {
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff;
        border-radius: 4px;
    }

    /* Style for the export buttons */
    .dt-buttons {
        margin-bottom: 15px;
    }

    .dt-button {
        padding: 6px 12px;
        margin-right: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
    }

    .dt-button:hover {
        background-color: #f0f0f0;
    }

    #download-duplicates-btn {
        background-color: #4CAF50;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 20px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    #download-duplicates-btn:hover {
        background-color: #45a049;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }

    #download-duplicates-btn {
        background-color: #28a745;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-left: 10px;
    }

    #download-duplicates-btn:hover {
        background-color: #218838;
    }

    #download-duplicates-btn i {
        font-size: 16px;
    }

    #summary-table thead th:first-child {
        cursor: pointer;
        position: relative;
    }

    #summary-table thead th:first-child:after {
        content: '↕';
        position: absolute;
        right: 8px;
        opacity: 0.5;
    }

    #summary-table thead th:first-child.sorting_asc:after {
        content: '↑';
        opacity: 1;
    }

    #summary-table thead th:first-child.sorting_desc:after {
        content: '↓';
        opacity: 1;
    }

    .sortable {
        cursor: pointer;
        position: relative;
    }
    
    .sortable:hover {
        background-color: #f5f5f5;
    }
    
    .sort-asc::after {
        content: ' ↑';
    }
    
    .sort-desc::after {
        content: ' ↓';
    }

    .highlight-duplicate {
        animation: highlight 1s ease-in-out;
    }

    @keyframes highlight {
        0% { background-color: #ffeb3b; }
        100% { background-color: transparent; }
    }

    #check-duplicates {
        margin: 10px;
        padding: 8px 15px;
    }

    #duplicate-count {
        font-weight: bold;
    }

    /* Animation for highlighting */
    @keyframes highlightFade {
        from { background-color: #ffebee; }
        to { background-color: transparent; }
    }

    .highlight-duplicate {
        animation: highlightFade 2s ease-in-out;
    }

    .duplicate-highlight {
        background-color: #ffe6e6 !important;
        color: red !important;
        font-weight: bold !important;
    }

    #check-duplicates {
        margin: 10px;
        padding: 8px 15px;
    }

    #duplicate-count {
        font-weight: bold;
    }

    .chart-control {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 150px;
    }
    
    .visualization-section {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-top: 30px;
    }
    
    canvas {
        background-color: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .chart-control {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 180px;
        background-color: white;
    }

    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .chart-wrapper {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .download-chart-btn {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .download-chart-btn:hover {
        background-color: #45a049;
    }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    canvas {
        width: 100% !important;
        max-height: 400px;
    }




    .content{
        background-color: white;
        width: 100%;
    }


    .vertical-nav {
        width: 210px;
        background: #2c3e50;
        padding: 30px 0;
        border-radius: 10px;
    }

    .vertical-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .vertical-nav li {
        margin: 0;
        padding: 0;
    }

    .vertical-nav a {
        display: flex;
        align-items: center;
        padding: 15px 25px;
        color: #ecf0f1;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .vertical-nav a:hover {
        background: #34495e;
        padding-left: 30px;
    }

    .vertical-nav i {
        margin-right: 15px;
        width: 20px;
        text-align: center;
    }

    .vertical-nav span {
        font-size: 16px;
    }

    /* Active link styling */
    .vertical-nav a.active {
        background: #3498db;
        border-left: 4px solid #2980b9;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .vertical-nav {
            width: 100%;
        }
        
        .vertical-nav span {
            display: none;
        }
        
        .vertical-nav a {
            justify-content: center;
            padding: 15px;
        }
        
        .vertical-nav i {
            margin: 0;
            font-size: 20px;
        }
    }
    .secContent{
        border-top-left-radius: 25px;
        padding: 20px;
        background-color: #012141;
        width: 25%;
        justify-content: center;
        
    }

    .content-box{
        width: 100%;
    }
    .container{
        width: 100%;
        display: flex; /* Add display flex to enable proper layout */
        padding: 0; /* Remove any padding that might affect full width */
        margin: 0; /* Remove any margins that might affect full width */
         /* Ensure padding doesn't add to width */
    }
    .containers{
        display: flex;
        width: 100%;
        flex: 1; /* Allow content to take remaining space */
        padding: 20px; /* Add padding inside the content area instead */
    }

    .data-table {
        margin: 20px 0;
        overflow-x: auto;
    }

    #data-table {
        width: 100% !important;
        border-collapse: collapse;
    }

    #data-table th,
    #data-table td {
        padding: 12px 8px;
        white-space: nowrap;
    }

    #data-table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .dataTables_wrapper {
        width: 100%;
        margin: 0 auto;
    }

    /* Fix container width issues */
    .content-box {
        width: 100%;
        padding: 20px;
       
    }

    .containers {
        display: flex;
        width: 100%;
        
        box-sizing: border-box;
    }

    /* Adjust sidebar width */
    .secContent {
        width: 250px;
        flex-shrink: 0;
    }

    /* Make main content area flexible */
    .content-box {
        flex: 1;
        min-width: 0; /* Prevent content from overflowing */
    }

    #entries-dropdown {
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
    }

    #entries-dropdown:focus {
        outline: none;
        border-color: #4CAF50;
    }

    #duplicate-popup .modal-content {
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #duplicate-popup .ok-button:hover {
        background-color: #45a049;
    }

    #view-duplicates-link:hover {
        text-decoration: underline;
    }
</style>
</head>

<body>
    <div class="containers">

        <!-- Sidebar content... -->
    <!-- Sidebar content... -->
    <div class="secContent">
        <div class="navbarsec">
            <h1 style="color: white;text-align: center;">Hello, {{ username }}</h1>
            <nav class="vertical-nav">
                <ul>
                    <li>
                        <a href="/home">
                            <i class="fas fa-home"></i>
                            <span>Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="/dashboard">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="/attendance">
                            <i class="fas fa-calendar-check"></i>
                            <span>Attendance</span>
                        </a>
                    </li>
                    <li>
                        <a href="/settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li>
                        <a href="/data_upload">
                            <i class="fas fa-upload"></i>
                            <span>Upload Data</span>
                        </a>
                    </li>
                    <li>
                        <a href="/logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>


        <!-- Main content area with shadow box -->
        <div class="content">
            <div class="content-box">
                <div class="welcome-message">Hello, {{ username }}</div>
                <h2>Dashboard</h2>

                <!-- Table View Button -->
                <button id="table-view-btn">Table View</button>
                <button id="updatePartnerBtn" class="btn btn-primary">Update Partner Info</button>
                <button id="allFieldsBtn" class="btn btn-primary">Save DB</button>

                <!-- Send Email Button -->
                
                <!-- <form method="POST" action="/dashboard">
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
                        Send Report via Email
                    </button>
                </form> -->


                <!-- <button id="send-email-button" class="btn btn-primary" style="margin-top: 20px;">
                    Send Email
                </button> -->
                
                <!-- Loading Indicator (hidden initially) -->
                <div id="loading-indicator" class="loading-popup" style="display: none;">
                    Sending Email...
                </div>
                
                <!-- Success popup div -->
                <div id="success-message" class="success-popup" style="display: none;">
                    Success!
                </div>


                <!-- Replace the existing email button and script with this updated version -->
                <button id="send-email-button" class="btn btn-primary" style="margin-top: 20px;">
                    Send Filtered Data via Email
                </button>

                <script>
                    document.getElementById('send-email-button').addEventListener('click', function () {
                        // Get the DataTable instance
                        const table = $('#data-table').DataTable();
                        
                        // Get filtered data
                        const filteredData = [];
                        table.rows({ filter: 'applied' }).every(function() {
                            const rowData = this.data();
                            filteredData.push({
                                'Phone': rowData[0],
                                'Disbursed Amount': rowData[1],
                                'Disbursal Date': rowData[2],
                                'Status': rowData[3],
                                'Lender': rowData[4],
                                'Created At': rowData[5],
                                'Partner': rowData[6]
                            });
                        });

                        // Show loading indicator
                        document.getElementById('loading-indicator').style.display = 'block';

                        // Send filtered data to server
                        fetch('/dashboard', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                filteredData: filteredData,
                                totalRecords: filteredData.length,
                                totalAmount: filteredData.reduce((sum, row) => sum + (parseFloat(row['Disbursed Amount']) || 0), 0)
                            })
                        })
                        .then(response => {
                            // Hide loading indicator
                            document.getElementById('loading-indicator').style.display = 'none';

                            if (response.ok) {
                                // Show success message
                                document.getElementById('success-message').style.display = 'block';
                                
                                // Hide success message after 3 seconds
                                setTimeout(function() {
                                    document.getElementById('success-message').style.display = 'none';
                                }, 3000);
                            } else {
                                response.text().then(text => alert(`Error sending email: ${text}`));
                            }
                        })
                        .catch(error => {
                            // Hide loading indicator and show error
                            document.getElementById('loading-indicator').style.display = 'none';
                            alert(`Error: ${error.message}`);
                        });
                    });
                </script>

                <!-- Add this to your existing modal email button as well -->
                <script>
                    document.getElementById('modal-send-email-button').addEventListener('click', function () {
                        // Get the summary table data
                        const summaryData = [];
                        $('#summary-tbody tr').each(function() {
                            const row = {};
                            $(this).find('td').each(function(index) {
                                const header = $('#summary-header th').eq(index).text();
                                row[header] = $(this).text();
                            });
                            summaryData.push(row);
                        });

                        // Show loading indicator
                        document.getElementById('loading-indicator').style.display = 'block';

                        // Send summary data to server
                        fetch('/dashboard', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                summaryData: summaryData,
                                viewType: $('#view-type').val(),
                                partnerFilter: $('#partner-filter').val()
                            })
                        })
                        .then(response => {
                            // Hide loading indicator
                            document.getElementById('loading-indicator').style.display = 'none';

                            if (response.ok) {
                                // Show success message
                                document.getElementById('success-message').style.display = 'block';
                                
                                // Hide success message after 3 seconds
                                setTimeout(function() {
                                    document.getElementById('success-message').style.display = 'none';
                                }, 3000);
                            } else {
                                response.text().then(text => alert(`Error sending email: ${text}`));
                            }
                        })
                        .catch(error => {
                            // Hide loading indicator and show error
                            document.getElementById('loading-indicator').style.display = 'none';
                            alert(`Error: ${error.message}`);
                        });
                    });
                </script>

                <!-- Plus Button to Add New Dropdowns -->
                <button id="add-dropdown-btn" style="margin-bottom: 20px;">+</button>

                <!-- Container for Dynamically Created Dropdowns -->
                <div id="dynamic-dropdowns" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>

                <!-- Lender, Month, Year, Date Range, and Created At Filters -->
                <div class="filters" style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                    <!-- Lender Dropdown -->
                    <div style="flex: 1;">
                        <label for="lender-dropdown">Select Lender:</label>
                        <select id="lender-dropdown" style="width: 100%;">
                            <option value="">All Lenders</option>
                            {% for lender in lender_options %}
                            <option value="{{ lender }}">{{ lender }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Month Dropdown -->
                    <div style="flex: 1;">
                        <label for="month-dropdown">Select Month:</label>
                        <select id="month-dropdown" style="width: 100%;">
                            <option value="">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>

                    <!-- Year Dropdown -->
                    <div style="flex: 1;">
                        <label for="year-dropdown">Select Year:</label>
                        <select id="year-dropdown" style="width: 100%;">
                            <option value="">All Years</option>
                            <!-- Populate years dynamically -->
                        </select>
                    </div>

                    <!-- Date Range Filter -->
                    <div style="flex: 1;">
                        <label for="date-range-filter">Select Date Range:</label>
                        <input type="text" id="date-range-filter" style="width: 100%;" placeholder="Select Date Range">
                    </div>

                    <!-- Created At Dropdown -->
                    <div style="flex: 1;">
                        <label for="created-at-dropdown">Select Created At:</label>
                        <select id="created-at-dropdown" style="width: 100%;">
                            <option value="">All Dates</option>
                            {% for created_at in created_at_options %}
                            <option value="{{ created_at }}">{{ created_at }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Partner Dropdown -->
                    <div style="flex: 1;">
                        <label for="partner-dropdown">Select Partner:</label>
                        <select id="partner-dropdown" style="width: 100%;">
                            <option value="">All Partners</option>
                            {% for partner in partner_options %}
                            <option value="{{ partner }}">{{ partner if partner != 'None' else 'None' }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Modal Popup for Table View -->
                <div id="table-view-modal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <button id="modal-send-email-button" class="download-button">Send Email</button>
                        <h3>Lender-wise Monthly Summary</h3>

                        <!-- Add view type dropdown -->
                        <div style="margin-bottom: 20px; display: flex; gap: 20px;">
                            <!-- Partner Filter dropdown -->
                            <div>
                                <label for="partner-filter">Partner Filter:</label>
                                <select id="partner-filter" style="margin-left: 10px;">
                                    <option value="">All Partners</option>
                                    <option value="MoneyTap">MoneyTap</option>
                                    <option value="MoneyView">DTMF</option>
                                    <option value="None">None</option>
                                    <option value="Zype_LS">Zype_LS</option>
                                </select>
                            </div>

                            <!-- View Type dropdown -->
                            <div>
                                <label for="view-type">View Type:</label>
                                <select id="view-type" style="margin-left: 10px;">
                                    <option value="count">Count</option>
                                    <option value="amount">Amount</option>
                                    <option value="payout">Payout (3%)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dynamic Summary Table Structure -->
                        <table id="summary-table" class="display" style="width:100%; margin-top: 20px;">
                            <thead>
                                <tr id="summary-header">
                                    <th class="sortable" data-sort="month">Month ↕</th>
                                    <!-- Lender columns will be added dynamically -->
                                    <th class="sortable" data-sort="total">Total ↕</th>
                                </tr>
                            </thead>
                            <tbody id="summary-tbody">
                                <!-- Rows will be inserted dynamically -->
                            </tbody>
                            <tfoot>
                                <tr id="summary-footer">
                                    <td>Total</td>
                                    <!-- Total cells will be added dynamically -->
                                </tr>
                            </tfoot>
                        </table>

                        <script>
                            document.getElementById('modal-send-email-button').addEventListener('click', function () {
                                // Get the summary table data
                                const summaryData = [];
                                $('#summary-tbody tr').each(function() {
                                    const row = {};
                                    $(this).find('td').each(function(index) {
                                        const header = $('#summary-header th').eq(index).text();
                                        row[header] = $(this).text();
                                    });
                                    summaryData.push(row);
                                });

                                // Show loading indicator
                                document.getElementById('loading-indicator').style.display = 'block';

                                // Send summary data to server
                                fetch('/dashboard', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ 
                                        summaryData: summaryData,
                                        viewType: $('#view-type').val(),
                                        partnerFilter: $('#partner-filter').val()
                                    })
                                })
                                .then(response => {
                                    // Hide loading indicator
                                    document.getElementById('loading-indicator').style.display = 'none';

                                    if (response.ok) {
                                        // Show success message
                                        document.getElementById('success-message').style.display = 'block';
                                        
                                        // Hide success message after 3 seconds
                                        setTimeout(function() {
                                            document.getElementById('success-message').style.display = 'none';
                                        }, 3000);
                                    } else {
                                        response.text().then(text => alert(`Error sending email: ${text}`));
                                    }
                                })
                                .catch(error => {
                                    // Hide loading indicator and show error
                                    document.getElementById('loading-indicator').style.display = 'none';
                                    alert(`Error: ${error.message}`);
                                });
                            });
                        </script>

                        <!-- Update the visualization section in the modal -->
                        <div class="visualization-section" style="margin-top: 30px;">
                            <h3>Data Visualization</h3>
                            
                            <!-- Enhanced controls for visualization -->
                            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                                <div class="chart-control-group">
                                    <label for="chart-type">Chart Type:</label>
                                    <select id="chart-type" class="chart-control">
                                        <option value="bar">Bar Chart</option>
                                        <option value="line">Line Chart</option>
                                        <option value="pie">Pie Chart</option>
                                        <option value="doughnut">Doughnut Chart</option>
                                        <option value="radar">Radar Chart</option>
                                        <option value="polarArea">Polar Area</option>
                                    </select>
                                </div>

                                <div class="chart-control-group">
                                    <label for="chart-data">Data View:</label>
                                    <select id="chart-data" class="chart-control">
                                        <option value="monthly">Monthly Trend</option>
                                        <option value="lender">Lender Distribution</option>
                                        <option value="status">Status Distribution</option>
                                        <option value="amount">Amount Distribution</option>
                                        <option value="partner">Partner Distribution</option>
                                    </select>
                                </div>

                                <div class="chart-control-group">
                                    <label for="time-period">Time Period:</label>
                                    <select id="time-period" class="chart-control">
                                        <option value="all">All Time</option>
                                        <option value="year">Last Year</option>
                                        <option value="6months">Last 6 Months</option>
                                        <option value="quarter">Last Quarter</option>
                                        <option value="month">Last Month</option>
                                    </select>
                                </div>

                                <div class="chart-control-group">
                                    <label for="value-type">Value Type:</label>
                                    <select id="value-type" class="chart-control">
                                        <option value="count">Count</option>
                                        <option value="amount">Amount</option>
                                        <option value="average">Average</option>
                                        <option value="payout">Payout (3%)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Chart containers with loading indicators -->
                            <div class="charts-container">
                                <div class="chart-wrapper">
                                    <div class="chart-header">
                                        <h4 id="main-chart-title">Primary Analysis</h4>
                                        <button class="download-chart-btn" data-chart="main">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                    <div class="loading-spinner main-chart-loader" style="display: none;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </div>
                                    <canvas id="mainChart"></canvas>
                                </div>

                                <div class="chart-wrapper">
                                    <div class="chart-header">
                                        <h4 id="trend-chart-title">Trend Analysis</h4>
                                        <button class="download-chart-btn" data-chart="trend">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                    <div class="loading-spinner trend-chart-loader" style="display: none;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </div>
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            

                <!-- jQuery, DataTables, and Date Range Picker JavaScript -->
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
                <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>


                <!-- Table with highlighted header -->
                <div class="data-table">
                    <table id="data-table" class="display">
                        <thead>
                            <tr>
                                <th style="background-color: #4CAF50;">Phone</th>
                                <th style="background-color: #4CAF50;">Disbursed Amount</th>
                                <th style="background-color: #4CAF50;">Disbursal Date</th>
                                <th style="background-color: #4CAF50;">Status</th>
                                <th style="background-color: #4CAF50;">Lender</th>
                                <th style="background-color: #4CAF50;">Created At</th>
                                <th style="background-color: #4CAF50;">Partner</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_data %}
                            <tr>
                                <td>{{ row.phone }}</td>
                                <td>{{ row.disbursedamount }}</td>
                                <td>{{ row.disbursaldate }}</td>
                                <td>{{ row.status }}</td>
                                <td>{{ row.Lender }}</td>
                                <td>{{ row.createdAt }}</td>
                                <td>{{ row.Partner }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td>Total:</td>
                                <td id="total-disbursed">{{ total_disbursed }}</td>
                                <td colspan="5" id="total-count">{{ total_count }} records</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Add this modal structure after your existing modals -->
                <div id="duplicateModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Duplicate Phone Numbers</h2>
                            <span class="close" id="closeDuplicateModal">&times;</span>
                            <button id="download-duplicates-btn">
                                <i class="fas fa-download"></i> Download CSV
                            </button>
                        </div>
                        <div class="modal-body">
                            <table id="duplicate-table" class="display">
                                <thead>
                                    <tr>
                                        <th>Phone Number</th>
                                        <th>Count</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Add these buttons after your existing buttons -->
                <button id="check-duplicates-btn">Check Duplicates</button>
                <button id="duplicate-btn">View Duplicates</button>

                <!-- Add this HTML structure after your existing modals -->
                <div id="duplicate-popup" class="modal" style="display: none;">
                    <div class="modal-content" style="background-color: #e8f5e9; max-width: 400px; text-align: center; padding: 30px;">
                        <p id="duplicate-count-message" style="font-size: 16px; margin-bottom: 15px;"></p>
                        <p style="font-size: 14px; margin-bottom: 20px;">
                            Click "<a href="#" id="view-duplicates-link" style="color: #4CAF50; text-decoration: none;">View Duplicates</a>" to see details.
                        </p>
                        <button class="ok-button" style="background-color: #4CAF50; color: white; border: none; padding: 10px 30px; border-radius: 4px; cursor: pointer;">OK</button>
                    </div>
                </div>

                <!-- Add this JavaScript after your existing scripts -->
                <script>
                $(document).ready(function() {
                    // Initialize duplicate table
                    const duplicateTable = $('#duplicate-table').DataTable({
                        pageLength: 25,
                        order: [[1, 'desc']],
                        dom: 'Bfrtip',
                        buttons: ['copy', 'csv', 'excel']
                    });

                    // Function to show duplicates modal
                    function showDuplicatesModal() {
                        duplicateTable.clear();
                        const phoneDetails = {};
                        
                        // First pass: collect all phone numbers and their occurrences
                        $('#data-table').DataTable().rows().every(function() {
                            const data = this.data();
                            const phone = data[0];
                            const amount = data[1];
                            const date = data[2];
                            const status = data[3];
                            const lender = data[4];
                            const createdAt = data[5];
                            const partner = data[6];
                            
                            if (!phoneDetails[phone]) {
                                phoneDetails[phone] = {
                                    count: 1,
                                    entries: [{
                                        amount: amount,
                                        date: date,
                                        status: status,
                                        lender: lender,
                                        createdAt: createdAt,
                                        partner: partner
                                    }]
                                };
                            } else {
                                phoneDetails[phone].count++;
                                phoneDetails[phone].entries.push({
                                    amount: amount,
                                    date: date,
                                    status: status,
                                    lender: lender,
                                    createdAt: createdAt,
                                    partner: partner
                                });
                            }
                        });

                        // Add entries with duplicates to the table
                        Object.entries(phoneDetails).forEach(([phone, details]) => {
                            if (details.count > 1) {
                                details.entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                                
                                const detailsHtml = details.entries.map((entry, index) => 
                                    `<div style="margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                        <strong>Entry ${index + 1}:</strong><br>
                                        <strong>Lender:</strong> ${entry.lender}<br>
                                        <strong>Date:</strong> ${entry.date}<br>
                                        <strong>Amount:</strong> ₹${parseFloat(entry.amount).toLocaleString('en-IN')}<br>
                                        <strong>Status:</strong> ${entry.status}<br>
                                        <strong>Created At:</strong> ${entry.createdAt}<br>
                                        <strong>Partner:</strong> ${entry.partner}
                                    </div>`
                                ).join('');

                                duplicateTable.row.add([
                                    `<span style="font-weight: bold;">${phone}</span>`,
                                    `<span style="color: red; font-weight: bold;">${details.count}</span>`,
                                    detailsHtml
                                ]);
                            }
                        });

                        duplicateTable.draw();
                        document.getElementById('duplicateModal').style.display = "block";

                        // Add summary information
                        const totalDuplicates = duplicateTable.rows().count();
                        const summaryHtml = `
                            <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                <strong>Total Duplicate Numbers Found:</strong> ${totalDuplicates}<br>
                            </div>
                        `;
                        
                        $('#duplicate-table_wrapper').before(summaryHtml);
                    }

                    // Event handlers
                    $('#duplicate-btn').on('click', showDuplicatesModal);
                    
                    $('#closeDuplicateModal').on('click', function() {
                        document.getElementById('duplicateModal').style.display = "none";
                    });

                    // Close modal when clicking outside
                    window.onclick = function(event) {
                        if (event.target == document.getElementById('duplicateModal')) {
                            document.getElementById('duplicateModal').style.display = "none";
                        }
                    }

                    // Download duplicates functionality
                    $('#download-duplicates-btn').on('click', function() {
                        try {
                            let csvData = [];
                            csvData.push(['Phone Number', 'Occurrences', 'Lender', 'Date', 'Amount', 'Status', 'Created At', 'Partner']);
                            
                            $('#duplicate-table tbody tr').each(function() {
                                const phone = $(this).find('td:first').text().trim();
                                const occurrences = $(this).find('td:nth-child(2)').text().trim();
                                const detailsCell = $(this).find('td:last');
                                
                                detailsCell.find('div').each(function() {
                                    const entryText = $(this).html();
                                    
                                    const lender = $(this).find('strong:contains("Lender:") + br').text().trim() ||
                                                 entryText.match(/Lender:\s*([^<\n]+)/)?.[1]?.trim() || '';
                                    const date = $(this).find('strong:contains("Date:") + br').text().trim() ||
                                                entryText.match(/Date:\s*([^<\n]+)/)?.[1]?.trim() || '';
                                    const amount = $(this).find('strong:contains("Amount:") + br').text().trim() ||
                                                 entryText.match(/Amount:\s*₹?([^<\n]+)/)?.[1]?.trim() || '';
                                    const status = $(this).find('strong:contains("Status:") + br').text().trim() ||
                                                 entryText.match(/Status:\s*([^<\n]+)/)?.[1]?.trim() || '';
                                    const createdAt = $(this).find('strong:contains("Created At:") + br').text().trim() ||
                                                    entryText.match(/Created At:\s*([^<\n]+)/)?.[1]?.trim() || '';
                                    const partner = $(this).find('strong:contains("Partner:") + br').text().trim() ||
                                                  entryText.match(/Partner:\s*([^<\n]+)/)?.[1]?.trim() || '';

                                    const cleanAmount = amount.replace(/[₹,]/g, '').trim();

                                    csvData.push([
                                        phone,
                                        occurrences,
                                        lender,
                                        date,
                                        cleanAmount,
                                        status,
                                        createdAt,
                                        partner
                                    ]);
                                });
                            });

                            const csvContent = csvData.map(row => 
                                row.map(cell => {
                                    if (cell === null || cell === undefined) return '""';
                                    const cellStr = String(cell);
                                    return cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n') 
                                        ? `"${cellStr.replace(/"/g, '""')}"` 
                                        : cellStr;
                                }).join(',')
                            ).join('\n');

                            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement('a');
                            const timestamp = new Date().toISOString().slice(0,10);
                            const filename = `duplicate_numbers_${timestamp}.csv`;
                            
                            if (navigator.msSaveBlob) {
                                navigator.msSaveBlob(blob, filename);
                            } else {
                                link.href = URL.createObjectURL(blob);
                                link.download = filename;
                                link.style.visibility = 'hidden';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(link.href);
                            }
                            
                            console.log('Download completed successfully');
                        } catch (error) {
                            console.error('Download error:', error);
                            alert('Error downloading file. Please check console for details.');
                        }
                    });

                    // Function to highlight duplicate phone numbers
                    $('#check-duplicates-btn').on('click', function() {
                        const table = $('#data-table').DataTable();
                        const phoneMap = new Map();
                        
                        // Reset previous highlighting
                        table.rows().every(function() {
                            $(this.node()).find('td:first').removeClass('duplicate-highlight');
                        });

                        // First pass: collect phone numbers from first column
                        table.rows().every(function() {
                            const phone = this.data()[0]?.toString().trim(); // Get first column (Phone)
                            
                            if (phone) {
                                if (phoneMap.has(phone)) {
                                    phoneMap.set(phone, phoneMap.get(phone) + 1);
                                } else {
                                    phoneMap.set(phone, 1);
                                }
                            }
                        });

                        // Second pass: highlight duplicates and count them
                        let duplicateCount = 0;
                        table.rows().every(function() {
                            const phone = this.data()[0]?.toString().trim();
                            
                            if (phone && phoneMap.get(phone) > 1) {
                                // Find and highlight the phone cell (first column)
                                const row = $(this.node());
                                const phoneCell = row.find('td:first');
                                
                                // Apply highlighting class
                                phoneCell.addClass('duplicate-highlight');
                                
                                // Add animation class
                                phoneCell.addClass('highlight-duplicate');
                                
                                // Remove animation class after animation completes
                                setTimeout(() => {
                                    phoneCell.removeClass('highlight-duplicate');
                                }, 2000);
                            }
                        });

                        // Count unique duplicate numbers
                        duplicateCount = Array.from(phoneMap.entries())
                            .filter(([_, count]) => count > 1).length;

                        if (duplicateCount > 0) {
                            // Show custom popup
                            $('#duplicate-message').text(`Found ${duplicateCount} phone numbers with duplicates.`);
                            $('#duplicate-popup').show();
                        } else {
                            $('#duplicate-message').text('No duplicate numbers found.');
                            $('#duplicate-popup').show();
                        }
                    });

                    // Add click handler for the View Duplicates link
                    $('#view-duplicates-link').on('click', function(e) {
                        e.preventDefault();
                        $('#duplicate-popup').hide();
                        $('#duplicate-btn').click(); // Trigger the View Duplicates button click
                    });

                    // Function to close the popup
                    function closeDuplicatePopup() {
                        $('#duplicate-popup').hide();
                    }

                    // Close popup when clicking outside
                    $(window).on('click', function(e) {
                        if ($(e.target).is('#duplicate-popup')) {
                            closeDuplicatePopup();
                        }
                    });
                });
                </script>

                <script>
                // Initialize chart variables
                let mainChart = null;
                let trendChart = null;

                // Update the updateCharts function to handle value type and time period filters
                function updateCharts() {
                    // Get filter values
                    const valueType = $('#value-type').val();
                    const timePeriod = $('#time-period').val();
                    
                    // Get the table data with applied filters
                    const summaryData = {};
                    const months = [];
                    const lenders = new Set();
                    
                    // Apply time period filter
                    const currentDate = new Date();
                    let startDate = new Date();
                    
                    switch(timePeriod) {
                        case 'month':
                            startDate.setMonth(currentDate.getMonth() - 1);
                            break;
                        case 'quarter':
                            startDate.setMonth(currentDate.getMonth() - 3);
                            break;
                        case '6months':
                            startDate.setMonth(currentDate.getMonth() - 6);
                            break;
                        case 'year':
                            startDate.setFullYear(currentDate.getFullYear() - 1);
                            break;
                        case 'all':
                        default:
                            startDate = new Date(0); // Beginning of time
                    }

                    // Collect data from the summary table with time period filter
                    $('#summary-tbody tr').each(function() {
                        const month = $(this).find('td:first').text();
                        const [monthName, year] = month.split('-');
                        const rowDate = new Date(year, getMonthNumber(monthName));
                        
                        // Skip if row date is before start date
                        if (rowDate < startDate) return;
                        
                        months.push(month);
                        
                        const rowData = {};
                        $(this).find('td').each(function(index) {
                            if (index > 0 && index < $(this).parent().find('td').length - 1) {
                                const lenderName = $('#summary-header th').eq(index).text();
                                lenders.add(lenderName);
                                
                                // Get value based on selected value type
                                let value = parseFloat($(this).text().replace(/[₹,]/g, '')) || 0;
                                switch(valueType) {
                                    case 'amount':
                                        // Value is already the amount
                                        break;
                                    case 'count':
                                        value = value > 0 ? 1 : 0; // Convert to count
                                        break;
                                    case 'average':
                                        // Calculate average if we have count data
                                        const count = $(this).data('count') || 1;
                                        value = value / count;
                                        break;
                                    case 'payout':
                                        value = value * 0.03; // Calculate 3% payout
                                        break;
                                }
                                
                                rowData[lenderName] = value;
                            }
                        });
                        summaryData[month] = rowData;
                    });

                    // Update charts with filtered data
                    if (mainChart) mainChart.destroy();
                    if (trendChart) trendChart.destroy();

                    // Create the main chart
                    const ctx = document.getElementById('mainChart').getContext('2d');
                    const chartType = $('#chart-type').val();

                    const datasets = Array.from(lenders).map(lender => ({
                        label: lender,
                        data: months.map(month => summaryData[month][lender] || 0),
                        backgroundColor: getColorForLender(lender),
                        borderWidth: 1
                    }));

                    mainChart = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: months,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { stacked: true },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: getYAxisLabel(valueType)
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: getChartTitle(valueType, timePeriod)
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });

                    // Create trend chart
                    const trendCtx = document.getElementById('trendChart').getContext('2d');
                    const monthlyTotals = months.map(month => {
                        return Object.values(summaryData[month]).reduce((sum, val) => sum + (val || 0), 0);
                    });

                    trendChart = new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: `${valueType.charAt(0).toUpperCase() + valueType.slice(1)} Trend`,
                                data: monthlyTotals,
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: getYAxisLabel(valueType)
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${timePeriod.charAt(0).toUpperCase() + timePeriod.slice(1)} Trend Analysis`
                                }
                            }
                        }
                    });
                }

                // Helper functions
                function getMonthNumber(monthName) {
                    const months = {
                        'January': 0, 'February': 1, 'March': 2, 'April': 3,
                        'May': 4, 'June': 5, 'July': 6, 'August': 7,
                        'September': 8, 'October': 9, 'November': 10, 'December': 11
                    };
                    return months[monthName];
                }

                function getYAxisLabel(valueType) {
                    switch(valueType) {
                        case 'amount':
                            return 'Amount (₹)';
                        case 'count':
                            return 'Number of Transactions';
                        case 'average':
                            return 'Average Amount (₹)';
                        case 'payout':
                            return 'Payout Amount (₹)';
                        default:
                            return '';
                    }
                }

                function getChartTitle(valueType, timePeriod) {
                    const valueTypeLabel = valueType.charAt(0).toUpperCase() + valueType.slice(1);
                    const timePeriodLabel = timePeriod.charAt(0).toUpperCase() + timePeriod.slice(1);
                    return `${valueTypeLabel} Distribution (${timePeriodLabel})`;
                }

                // Add event listeners for the filters
                $('#value-type, #time-period').on('change', updateCharts);

                // Helper function to get consistent colors for lenders
                function getColorForLender(lender) {
                    const colorMap = {
                        'MVCancel': '#4CAF50',
                        'MoneyView': '#2196F3',
                        'Mpokket': '#FFC107',
                        // Add more lenders and colors as needed
                    };
                    return colorMap[lender] || '#' + Math.floor(Math.random()*16777215).toString(16);
                }

                // Add event listeners for chart controls
                $('#chart-type, #chart-data').on('change', updateCharts);

                // Update charts when table view is opened
                $('#table-view-btn').on('click', function() {
                    setTimeout(updateCharts, 500);
                });

                // Initial chart update
                $(document).ready(function() {
                    // Add event listener for view type changes
                    $('#view-type').on('change', updateCharts);
                });
                </script>
            </div>
        </div>

    </div>




    <!-- jQuery, DataTables, and Date Range Picker JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        function sendEmail() {
            // Collect selected data (modify this according to your data selection logic)
            const selectedData = getSelectedData(); // Implement this function to get selected data

            fetch('/send_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ data: selectedData }),
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    </script>
</body>

</html>
</div>
</div>

<!-- jQuery, DataTables, and Date Range Picker JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<script>
    $(document).ready(function () {
        const table = $('#data-table').DataTable();

        // Populate Year Dropdown dynamically based on available years
        function populateYearDropdown() {
            const yearDropdown = $('#year-dropdown');
            const startYear = 2020;
            const endYear = new Date().getFullYear();

            for (let year = startYear; year <= endYear; year++) {
                yearDropdown.append(`<option value="${year}">${year}</option>`);
            }
        }
        populateYearDropdown();

        // Function to apply filters including the month filter
        function applyFilters() {
            const selectedLender = $('#lender-dropdown').val();
            const selectedMonth = $('#month-dropdown').val();
            const selectedYear = $('#year-dropdown').val();
            const dateRange = $('#date-range-filter').val();
            const createdAt = $('#created-at-dropdown').val();
            const selectedPartner = $('#partner-dropdown').val(); // Add this line

            // Reset filters
            table.column(4).search(''); // Reset Lender column filter
            table.column(2).search(''); // Reset disbursal date column filter
            table.column(5).search(''); // Reset created at column filter
            table.column(6).search(''); // Reset partner column filter

            // Apply partner filter
            if (selectedPartner) {
                table.column(6).search(`^${selectedPartner}$`, true, false);
            }

            // Filter by lender
            if (selectedLender) {
                table.column(4).search(`^${selectedLender}$`, true, false).draw();
            }

            // Filter by both month and year if selected
            if (selectedMonth && selectedYear) {
                table.column(2).search(`^${selectedYear}-${selectedMonth}`, true, false).draw();
            } else if (selectedMonth) {
                table.column(2).search(`-${selectedMonth}-`, true, false).draw();
            } else if (selectedYear) {
                table.column(2).search(`^${selectedYear}-`, true, false).draw();
            }

            // Apply date range filter
            if (dateRange) {
                const [start, end] = dateRange.split(' - ');
                $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                    const date = data[2]; // Use column 2 (disbursaldate) for filtering
                    return date >= start && date <= end;
                });
            }

            // Apply created at filter
            if (createdAt) {
                table.column(5).search(`^${createdAt}$`, true, false).draw();
            }

            table.draw();
            updateTotals();
        }

        // Event listeners for filters
        $('#lender-dropdown, #month-dropdown, #year-dropdown, #date-range-filter, #created-at-dropdown, #partner-dropdown').on('change', applyFilters);

        // Initialize Date Range Picker for date range filter
        $('#date-range-filter').daterangepicker({
            autoUpdateInput: false,
            locale: {
                format: 'YYYY-MM-DD',
                cancelLabel: 'Clear'
            }
        });

        // Apply date range filter on date selection
        $('#date-range-filter').on('apply.daterangepicker', function (ev, picker) {
            const startDate = picker.startDate.format('YYYY-MM-DD');
            const endDate = picker.endDate.format('YYYY-MM-DD');
            $(this).val(startDate + ' - ' + endDate);
            applyFilters();
        });

        // Clear date range filter on cancel
        $('#date-range-filter').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
            applyFilters();
        });

        // Update totals based on filtered data
        function updateTotals() {
            let totalDisbursed = 0;
            let totalCount = 0;

            // Iterate over filtered rows to calculate totals
            table.rows({ filter: 'applied' }).every(function () {
                const data = this.data();
                const disbursedAmount = parseFloat(data[1]) || 0;
                totalDisbursed += disbursedAmount;
                totalCount++;
            });

            // Display updated totals in the footer
            $('#total-disbursed').text(totalDisbursed.toFixed(2));
            $('#total-count').text(`${totalCount} records`);
        }

        // Open and close modal functionality
        const modal = $('#table-view-modal');
        $('#table-view-btn').on('click', function () {
            updateSummaryTable();
            $('#summary-table').DataTable();  // Apply DataTables to summary table
            modal.show();
        });
        $('.close').on('click', function () {
            modal.hide();
            $('#summary-table').DataTable().destroy(); // Destroy DataTables instance on close
        });
        $(window).on('click', function (event) {
            if ($(event.target).is(modal)) {
                modal.hide();
                $('#summary-table').DataTable().destroy(); // Destroy DataTables instance on outside click
            }
        });

        // Update summary table based on filtered data
        function updateSummaryTable() {
            const summaryData = {};
            const lenderSet = new Set();
            const viewType = $('#view-type').val();
            const selectedPartner = $('#partner-filter').val();
            
            // First pass: collect all unique lenders and initialize data structure
            table.rows({ filter: 'applied' }).every(function() {
                const rowData = this.data();
                const partner = rowData[6]; // Partner column
                
                // Skip if partner doesn't match filter
                if (selectedPartner && partner !== selectedPartner) {
                    return;
                }
                
                // Only process rows that have valid dates
                if (rowData[2]) {  // rowData[2] is disbursaldate
                    const [day, month, year] = rowData[2].split('-');
                    const monthNames = [
                        'January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'
                    ];
                    const monthName = monthNames[parseInt(month) - 1];
                    const monthYear = `${monthName}-${year}`;
                    const lender = rowData[4];
                    const amount = parseFloat(rowData[1]) || 0;
                    
                    // Only create entry if we have valid data
                    if (amount > 0 || viewType === 'count') {
                        lenderSet.add(lender);
                        
                        if (!summaryData[monthYear]) {
                            summaryData[monthYear] = {
                                lenders: {},
                                totalCount: 0,
                                totalAmount: 0
                            };
                        }
                        if (!summaryData[monthYear].lenders[lender]) {
                            summaryData[monthYear].lenders[lender] = {
                                count: 0,
                                amount: 0
                            };
                        }
                        
                        summaryData[monthYear].lenders[lender].count++;
                        summaryData[monthYear].lenders[lender].amount += amount;
                        summaryData[monthYear].totalCount++;
                        summaryData[monthYear].totalAmount += amount;
                    }
                }
            });

            // Sort months chronologically
            const sortedMonths = Object.keys(summaryData).sort((a, b) => {
                const monthOrder = {
                    'January': 0, 'February': 1, 'March': 2, 'April': 3,
                    'May': 4, 'June': 5, 'July': 6, 'August': 7,
                    'September': 8, 'October': 9, 'November': 10, 'December': 11
                };
                
                const [monthA, yearA] = a.split('-');
                const [monthB, yearB] = b.split('-');
                
                if (yearA !== yearB) {
                    return parseInt(yearA) - parseInt(yearB);
                }
                return monthOrder[monthA] - monthOrder[monthB];
            });

            const lenders = Array.from(lenderSet).sort();

            // Update table header
            const headerRow = $('#summary-header');
            headerRow.empty().append('<th>Month</th>');
            lenders.forEach(lender => {
                headerRow.append(`<th>${lender}</th>`);
            });
            headerRow.append('<th>Total</th>');

            // Update table body
            const summaryTbody = $('#summary-tbody');
            summaryTbody.empty();
            
            sortedMonths.forEach(month => {
                const data = summaryData[month];
                let row = `<tr><td>${month}</td>`;
                
                let rowTotal = 0;
                lenders.forEach(lender => {
                    const lenderData = data.lenders[lender] || { count: 0, amount: 0 };
                    let value = 0;
                    
                    switch(viewType) {
                        case 'count':
                            value = lenderData.count;
                            rowTotal += value;
                            break;
                        case 'amount':
                            value = lenderData.amount;
                            rowTotal += value;
                            break;
                        case 'payout':
                            value = lenderData.amount * 0.03;
                            rowTotal += value;
                            break;
                    }
                    
                    // Make all non-zero values clickable with data attributes
                    row += `<td>${value > 0 ? 
                        `<a href="#" class="summary-cell-link" 
                            data-month="${month}" 
                            data-lender="${lender}" 
                            data-value="${value}"
                            data-view-type="${viewType}">${value.toLocaleString('en-IN', {maximumFractionDigits: 2})}</a>` : 
                        '0'}</td>`;
                });
                
                // Add row total with clickable link
                row += `<td><a href="#" class="summary-cell-link" 
                    data-month="${month}" 
                    data-lender="all" 
                    data-value="${rowTotal}"
                    data-view-type="${viewType}">${rowTotal.toLocaleString('en-IN', {maximumFractionDigits: 2})}</a></td></tr>`;
                summaryTbody.append(row);
            });

            // Add click handler for summary cells
            $('.summary-cell-link').off('click').on('click', function(e) {
                e.preventDefault();
                const month = $(this).data('month');
                const lender = $(this).data('lender');
                const viewType = $(this).data('view-type');
                
                // Get filtered data based on the cell clicked
                const filteredData = [];
                table.rows({ filter: 'applied' }).every(function() {
                    const rowData = this.data();
                    const rowDate = new Date(rowData[2]); // disbursal date
                    const rowMonth = `${rowDate.toLocaleString('default', { month: 'long' })}-${rowDate.getFullYear()}`;
                    const rowLender = rowData[4];
                    const rowPartner = rowData[6];
                    
                    // Check if row matches all filter criteria
                    if ((month === rowMonth || !month) && 
                        (lender === rowLender || lender === 'all' || !lender) &&
                        (!selectedPartner || rowPartner === selectedPartner)) {
                        
                        filteredData.push({
                            'Phone': rowData[0],
                            'Disbursed Amount': amount.toLocaleString('en-IN', {maximumFractionDigits: 2}),
                            'Disbursal Date': rowData[2],
                            'Status': rowData[3],
                            'Lender': rowData[4],
                            'Created At': rowData[5],
                            'Partner': rowData[6]
                        });
                    }
                });

                // Generate filename
                const timestamp = new Date().toISOString().split('T')[0];
                let filename = `${lender}_${month}_${viewType}_${timestamp}.csv`;
                
                // Download CSV
                downloadAsCSV(filteredData, filename);
            });

            // Update footer totals
            updateFooterTotals(summaryData, lenders, viewType);

            // Add sort handlers to headers
            $('.sortable').off('click').on('click', function() {
                const sortBy = $(this).data('sort');
                const isAsc = $(this).hasClass('sort-asc');
                
                // Remove sort indicators from all headers
                $('.sortable').removeClass('sort-asc sort-desc');
                
                // Add sort indicator to clicked header
                $(this).addClass(isAsc ? 'sort-desc' : 'sort-asc');
                
                // Sort the rows
                const tbody = $('#summary-tbody');
                const rows = tbody.find('tr').toArray();
                
                rows.sort((a, b) => {
                    let aVal, bVal;
                    
                    if (sortBy === 'month') {
                        const monthOrder = {
                            'January': 0, 'February': 1, 'March': 2, 'April': 3,
                            'May': 4, 'June': 5, 'July': 6, 'August': 7,
                            'September': 8, 'October': 9, 'November': 10, 'December': 11
                        };
                        
                        const [aMonth, aYear] = $(a).find('td:first').text().split('-');
                        const [bMonth, bYear] = $(b).find('td:first').text().split('-');
                        
                        // First compare years
                        if (aYear !== bYear) {
                            return isAsc ? 
                                parseInt(bYear) - parseInt(aYear) : 
                                parseInt(aYear) - parseInt(bYear);
                        }
                        
                        // If same year, compare months
                        return isAsc ? 
                            monthOrder[bMonth] - monthOrder[aMonth] : 
                            monthOrder[aMonth] - monthOrder[bMonth];
                    } else {
                        // For numeric columns (including total)
                        aVal = parseFloat($(a).find('td:last').text().replace(/[^0-9.-]+/g, '')) || 0;
                        bVal = parseFloat($(b).find('td:last').text().replace(/[^0-9.-]+/g, '')) || 0;
                        return isAsc ? bVal - aVal : aVal - bVal;
                    }
                });
                
                // Reattach sorted rows
                tbody.empty().append(rows);
            });
        }

        function updateFooterTotals(summaryData, lenders, viewType) {
            const footerRow = $('#summary-footer');
            footerRow.empty().append('<td>Total</td>');
            
            let grandTotal = 0;
            
            // Calculate column totals
            const columnTotals = lenders.map(lender => {
                let total = 0;
                Object.values(summaryData).forEach(monthData => {
                    const lenderData = monthData.lenders[lender] || { count: 0, amount: 0 };
                    switch(viewType) {
                        case 'count':
                            total += lenderData.count;
                            break;
                        case 'amount':
                            total += lenderData.amount;
                            break;
                        case 'payout':
                            total += lenderData.amount * 0.03;
                            break;
                    }
                });
                grandTotal += total;
                return total;
            });

            // Add lender totals with clickable links
            columnTotals.forEach((total, index) => {
                footerRow.append(`<td>
                    <a href="#" class="footer-total-link" 
                        data-lender="${lenders[index]}" 
                        data-value="${total}"
                        data-view-type="${viewType}">
                        ${total.toLocaleString('en-IN', {maximumFractionDigits: 2})}
                    </a>
                </td>`);
            });

            // Add grand total with clickable link
            footerRow.append(`<td>
                <a href="#" class="footer-total-link" 
                    data-lender="all" 
                    data-value="${grandTotal}"
                    data-view-type="${viewType}">
                    ${grandTotal.toLocaleString('en-IN', {maximumFractionDigits: 2})}
                </a>
            </td>`);

            // Add click handler for footer totals
            $('.footer-total-link').off('click').on('click', function(e) {
                e.preventDefault();
                const lender = $(this).data('lender');
                const viewType = $(this).data('view-type');
                
                // Get all data based on the footer total clicked
                const filteredData = [];
                table.rows().every(function() {
                    const rowData = this.data();
                    const rowLender = rowData[4];
                    
                    // Include row if it matches the lender filter (or all lenders)
                    if (lender === 'all' || rowLender === lender) {
                        filteredData.push([
                            rowData[0],  // Phone
                            rowData[1],  // Disbursed Amount
                            rowData[2],  // Disbursal Date
                            rowData[3],  // Status
                            rowData[4],  // Lender
                            rowData[5],  // Created At
                            rowData[6]   // Partner
                        ]);
                    }
                });

                // Generate filename for footer totals
                const timestamp = new Date().toISOString().split('T')[0];
                const filePrefix = lender === 'all' ? 'All_Lenders' : lender;
                const filename = `${filePrefix}_Total_${viewType}_${timestamp}.csv`;
                
                // Download CSV
                downloadAsCSV(filteredData, filename);
            });
        }

        // Event handler for download links
        $(document).on('click', '.download-link', function(e) {
            e.preventDefault();
            const month = $(this).data('month');
            const lender = $(this).data('lender');
            const viewType = $('#view-type').val();
            
            // Collect filtered data
            const filteredData = [];
            table.rows({ filter: 'applied' }).every(function() {
                const rowData = this.data();
                const rowDate = new Date(rowData[2]); // disbursal date
                const rowMonth = `${rowDate.toLocaleString('default', { month: 'long' })}-${rowDate.getFullYear()}`;
                const rowLender = rowData[4];
                const amount = parseFloat(rowData[1]) || 0;

                // Check if row matches the filter criteria
                if ((month === rowMonth || !month) && 
                    (lender === rowLender || lender === 'all' || !lender)) {
                    
                    let displayValue;
                    switch(viewType) {
                        case 'count':
                            displayValue = 1; // Each row counts as 1
                            break;
                        case 'amount':
                            displayValue = amount;
                            break;
                        case 'payout':
                            displayValue = amount * 0.03;
                            break;
                    }

                    filteredData.push({
                        'Phone Number': rowData[0],
                        'Disbursed Amount': amount.toLocaleString('en-IN', {maximumFractionDigits: 2}),
                        'Value': displayValue,
                        'Disbursal Date': rowData[2],
                        'Status': rowData[3],
                        'Lender': rowData[4],
                        'Created At': rowData[5],
                        'Partner': rowData[6]
                    });
                }
            });

            // Sort data by date
            filteredData.sort((a, b) => new Date(a['Disbursal Date']) - new Date(b['Disbursal Date']));

            // Calculate totals
            const totalAmount = filteredData.reduce((sum, row) => sum + (parseFloat(row['Disbursed Amount'].replace(/,/g, '')) || 0), 0);
            const totalValue = filteredData.reduce((sum, row) => sum + (parseFloat(row['Value']) || 0), 0);

            // Add summary row
            filteredData.push({
                'Phone Number': 'Total',
                'Disbursed Amount': totalAmount.toLocaleString('en-IN', {maximumFractionDigits: 2}),
                'Value': totalValue.toLocaleString('en-IN', {maximumFractionDigits: 2}),
                'Disbursal Date': '',
                'Status': '',
                'Lender': '',
                'Created At': '',
                'Partner': `Total Records: ${filteredData.length - 1}` // -1 to exclude summary row
            });

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(filteredData);

            // Set column widths
            ws['!cols'] = [
                {wch: 15}, // Phone Number
                {wch: 15}, // Disbursed Amount
                {wch: 15}, // Value
                {wch: 12}, // Disbursal Date
                {wch: 10}, // Status
                {wch: 12}, // Lender
                {wch: 12}, // Created At
                {wch: 15}  // Partner
            ];

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Filtered Data');

            // Generate filename
            let filename = '';
            if (month && lender && lender !== 'all') {
                filename = `${lender}_${month}`;
            } else if (month) {
                filename = `All_Lenders_${month}`;
            } else if (lender && lender !== 'all') {
                filename = `${lender}_All_Months`;
            } else {
                filename = `All_Data`;
            }

            // Add view type and timestamp
            const timestamp = new Date().toISOString().split('T')[0];
            filename = `${filename}_${viewType}_${timestamp}.csv`;

            // Download file
            XLSX.writeFile(wb, filename);
        });

        // Add event listener for view type change
        $('#view-type').on('change', function() {
            updateSummaryTable();
        });

        // New function to handle CSV download
        function downloadAsCSV(data, filename) {
            // Define headers
            const headers = [
                'Phone',
                'Disbursed Amount',
                'Disbursal Date',
                'Status',
                'Lender',
                'Created At',
                'Partner'
            ];

            // Create CSV content
            let csvContent = headers.join(',') + '\n';

            // Add data rows
            data.forEach(row => {
                const formattedRow = row.map(cell => {
                    if (cell === null || cell === undefined) {
                        return '';
                    }
                    const cellStr = String(cell);
                    // Escape quotes and wrap fields containing commas or quotes
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                });
                csvContent += formattedRow.join(',') + '\n';
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Initial totals calculation on page load
        updateTotals();

        // Add click handler for download button
        $('#download-summary-btn').on('click', function() {
            const viewType = $('#view-type').val();
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `summary_${viewType}_${timestamp}.xlsx`;
            
            // Get table data
            const data = [];
            const headers = [];
            
            // Get headers
            $('#summary-header th').each(function() {
                headers.push($(this).text());
            });
            
            // Get row data
            $('#summary-tbody tr').each(function() {
                const rowData = {};
                $(this).find('td').each(function(index) {
                    // Get the text content, removing any commas and converting to number if needed
                    const value = $(this).text().replace(/,/g, '');
                    rowData[headers[index]] = index === 0 ? value : Number(value) || 0;
                });
                data.push(rowData);
            });
            
            // Add totals row
            const totalsRow = {};
            $('#summary-footer td').each(function(index) {
                const value = $(this).text().replace(/,/g, '');
                totalsRow[headers[index]] = index === 0 ? 'Total' : Number(value) || 0;
            });
            data.push(totalsRow);

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Set column widths
            const colWidths = headers.map(() => ({wch: 15}));
            ws['!cols'] = colWidths;

            // Create workbook and append worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Summary Data');

            // Download file
            XLSX.writeFile(wb, filename);
        });

        // Update the cell click handler
        $(document).on('click', '.summary-cell-link, .footer-total-link', function(e) {
            e.preventDefault();
            const month = $(this).data('month');
            const lender = $(this).data('lender');
            const viewType = $('#view-type').val();
            const selectedPartner = $('#partner-filter').val();
            
            // Get filtered data
            const filteredData = [];
            table.rows().every(function() {
                const rowData = this.data();
                const rowDate = new Date(rowData[2]); // disbursal date
                const rowMonth = `${rowDate.toLocaleString('default', { month: 'long' })}-${rowDate.getFullYear()}`;
                const rowLender = rowData[4];
                const rowPartner = rowData[6];
                const amount = parseFloat(rowData[1]) || 0;
                
                // Check if row matches all filter criteria
                if ((month === rowMonth || !month) && 
                    (lender === rowLender || lender === 'all' || !lender) &&
                    (!selectedPartner || rowPartner === selectedPartner)) {
                    
                    filteredData.push({
                        'Phone': rowData[0],
                        'Disbursed Amount': amount.toLocaleString('en-IN', {maximumFractionDigits: 2}),
                        'Disbursal Date': rowData[2],
                        'Status': rowData[3],
                        'Lender': rowData[4],
                        'Created At': rowData[5],
                        'Partner': rowData[6]
                    });
                }
            });

            // Sort data by date
            filteredData.sort((a, b) => new Date(a['Disbursal Date']) - new Date(b['Disbursal Date']));

            // Add summary row
            const totalAmount = filteredData.reduce((sum, row) => 
                sum + (parseFloat(row['Disbursed Amount'].replace(/,/g, '')) || 0), 0);

            filteredData.push({
                'Phone': 'Total',
                'Disbursed Amount': totalAmount.toLocaleString('en-IN', {maximumFractionDigits: 2}),
                'Disbursal Date': '',
                'Status': '',
                'Lender': '',
                'Created At': '',
                'Partner': `Total Records: ${filteredData.length - 1}`
            });

            // Generate filename
            const timestamp = new Date().toISOString().split('T')[0];
            let filename = '';
            if (month && lender && lender !== 'all') {
                filename = `${lender}_${month}`;
            } else if (month) {
                filename = `All_Lenders_${month}`;
            } else if (lender && lender !== 'all') {
                filename = `${lender}_All_Months`;
            } else {
                filename = `All_Data`;
            }
            filename = `${filename}_${viewType}_${timestamp}.xlsx`;

            // Create and download Excel file
            const ws = XLSX.utils.json_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Filtered Data');
            XLSX.writeFile(wb, filename);
        });

        // Remove or comment out any other download-related event handlers
        // Remove the old downloadAsCSV and downloadExcelFile functions if they're not used elsewhere
    });



    // ye neeche wala add kiya hai


    document.addEventListener('DOMContentLoaded', function () {
        const dynamicDropdownsContainer = document.getElementById('dynamic-dropdowns');
        const addDropdownBtn = document.getElementById('add-dropdown-btn');

        // Define possible header options
        const headerOptions = {
            "Lender": ["All Lenders", "Cashe", "Ramfin", "Fibe", "SmartCoin", "MV", "Mpokket", "MoneyView", "MVCancel"],
            "Month": ["All Months", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
            "Year": ["All Years", "2020", "2021", "2022", "24", "2024"],  // Adjust years dynamically if needed
            "Status": ["All Statuses", "Approved", "Pending", "Rejected"],  // Example status options
            "Partner": ["All Partners", "MoneyTap", "Zype_LS", "None"]  // Added Partner options
        };

        // Function to add a new dropdown
        function addNewDropdown() {
            // Create a container for each dropdown with label and delete button
            const dropdownContainer = document.createElement('div');
            dropdownContainer.style.display = 'flex';
            dropdownContainer.style.alignItems = 'center';
            dropdownContainer.style.marginBottom = '10px';

            // Create label for dropdown
            const dropdownLabel = document.createElement('label');
            dropdownLabel.textContent = 'Select Filter: ';
            dropdownLabel.style.marginRight = '10px';
            dropdownContainer.appendChild(dropdownLabel);

            // Create the dropdown itself
            const newDropdown = document.createElement('select');
            newDropdown.style.marginRight = '10px';

            // Populate dropdown with header options
            Object.keys(headerOptions).forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                newDropdown.appendChild(option);
            });

            // Append the dropdown to the container
            dropdownContainer.appendChild(newDropdown);

            // Create a secondary dropdown to hold the values of the selected header
            const valueDropdown = document.createElement('select');
            valueDropdown.style.marginRight = '10px';
            dropdownContainer.appendChild(valueDropdown);

            // Event listener to update value dropdown when a header is selected
            newDropdown.addEventListener('change', function () {
                const selectedHeader = newDropdown.value;
                const values = headerOptions[selectedHeader];

                // Clear any existing options
                valueDropdown.innerHTML = '';

                // Add the values based on selected header
                values.forEach(value => {
                    const valueOption = document.createElement('option');
                    valueOption.value = value;
                    valueOption.textContent = value;
                    valueDropdown.appendChild(valueOption);
                });
            });

            // Delete button to remove this dropdown
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'x';
            deleteButton.style.marginLeft = '10px';
            deleteButton.addEventListener('click', function () {
                dropdownContainer.remove();
            });
            dropdownContainer.appendChild(deleteButton);

            // Add the dropdown container to the main dynamic dropdowns container
            dynamicDropdownsContainer.appendChild(dropdownContainer);
        }

        // Add initial dropdown on page load
        addDropdownBtn.addEventListener('click', addNewDropdown);
    });





    // Show the modal
    function showModal() {
        document.getElementById("emailModal").style.display = "block";
    }

    // Close the modal
    function closeModal() {
        document.getElementById("emailModal").style.display = "none";
    }

    // Close the modal if clicked outside
    window.onclick = function (event) {
        const modal = document.getElementById("emailModal");
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Function to highlight duplicate phone numbers
    function checkDuplicates() {
        const table = $('#data-table').DataTable();
        const phoneMap = new Map();
        
        // Reset previous highlighting
        table.rows().every(function() {
            $(this.node()).find('td:first').removeClass('duplicate-highlight');
        });

        // First pass: collect phone numbers from first column
        table.rows().every(function() {
            const phone = this.data()[0]?.toString().trim(); // Get first column (Phone)
            
            if (phone) {
                if (phoneMap.has(phone)) {
                    phoneMap.set(phone, phoneMap.get(phone) + 1);
                } else {
                    phoneMap.set(phone, 1);
                }
            }
        });

        // Second pass: highlight duplicates and count them
        let duplicateCount = 0;
        table.rows().every(function() {
            const phone = this.data()[0]?.toString().trim();
            
            if (phone && phoneMap.get(phone) > 1) {
                // Find and highlight the phone cell (first column)
                const row = $(this.node());
                const phoneCell = row.find('td:first');
                
                // Apply highlighting class
                phoneCell.addClass('duplicate-highlight');
                
                // Add animation class
                phoneCell.addClass('highlight-duplicate');
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    phoneCell.removeClass('highlight-duplicate');
                }, 2000);
            }
        });

        // Count unique duplicate numbers
        duplicateCount = Array.from(phoneMap.entries())
            .filter(([_, count]) => count > 1).length;

        // Show alert with duplicate count
        if (duplicateCount > 0) {
            showDuplicatePopup(duplicateCount);
        } else {
            alert('No duplicate numbers found.');
        }
    }

    // Add event listener
    $(document).ready(function() {
        $('#check-duplicates').on('click', checkDuplicates);
    });

    // Function to show duplicate popup
    function showDuplicatePopup(duplicateCount) {
        const popup = document.getElementById('duplicate-popup');
        const message = document.getElementById('duplicate-message');
        const viewDuplicatesLink = document.getElementById('view-duplicates-link');

        message.textContent = `Found ${duplicateCount} phone numbers with duplicates.`;
        viewDuplicatesLink.href = '#';
        viewDuplicatesLink.addEventListener('click', function() {
            showDuplicatesModal();
        });

        popup.style.display = 'block';
    }

    // Function to close duplicate popup
    function closeDuplicatePopup() {
        const popup = document.getElementById('duplicate-popup');
        popup.style.display = 'none';
    }

    // Function to show duplicates modal
    function showDuplicatesModal() {
        const table = $('#data-table').DataTable();
        const phoneMap = new Map();
        
        // Collect phone numbers and their occurrences
        table.rows().every(function() {
            const phone = this.data()[0]?.toString().trim(); // Get first column (Phone)
            
            if (phone) {
                if (phoneMap.has(phone)) {
                    phoneMap.set(phone, phoneMap.get(phone) + 1);
                } else {
                    phoneMap.set(phone, 1);
                }
            }
        });

        // Filter out non-duplicate numbers
        const duplicates = Array.from(phoneMap.entries())
            .filter(([_, count]) => count > 1)
            .map(([phone, count]) => ({ phone, count }));

        // Sort duplicates by count in descending order
        duplicates.sort((a, b) => b.count - a.count);

        // Create table for duplicates
        const duplicateTable = document.createElement('table');
        duplicateTable.id = 'duplicate-table';
        duplicateTable.className = 'display';

        // Create table header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ['Phone', 'Count'];
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        duplicateTable.appendChild(thead);

        // Create table body
        const tbody = document.createElement('tbody');
        duplicates.forEach(duplicate => {
            const row = document.createElement('tr');
            const phoneCell = document.createElement('td');
            phoneCell.textContent = duplicate.phone;
            row.appendChild(phoneCell);
            const countCell = document.createElement('td');
            countCell.textContent = duplicate.count;
            row.appendChild(countCell);
            tbody.appendChild(row);
        });
        duplicateTable.appendChild(tbody);

        // Create table footer
        const tfoot = document.createElement('tfoot');
        const footerRow = document.createElement('tr');
        const footerCell = document.createElement('td');
        footerCell.colSpan = 2;
        footerCell.textContent = `Total Duplicates: ${duplicates.length}`;
        footerRow.appendChild(footerCell);
        tfoot.appendChild(footerRow);
        duplicateTable.appendChild(tfoot);

        // Create modal content
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.appendChild(duplicateTable);

        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.appendChild(modalContent);

        // Add modal to body
        document.body.appendChild(modal);

        // Initialize DataTable
        $(duplicateTable).DataTable({
            paging: true,
            ordering: true,
            info: true,
            searching: true,
            lengthChange: true,
            pageLength: 10,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'csv',
                    text: 'Download CSV',
                    className: 'btn btn-primary',
                    exportOptions: {
                        columns: ':visible'
                    }
                }
            ]
        });

        // Show modal
        $(modal).modal('show');

        // Remove modal when closed
        $(modal).on('hidden.bs.modal', function () {
            $(this).remove();
        });
    }

// Function to update partner information with batch processing
async function updatePartnerInfo() {
    const table = $('#data-table').DataTable();
    const loadingDiv = $('<div>Requesting partner info for phones...</div>')
        .css({
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            padding: '20px',
            background: 'rgba(0,0,0,0.8)',
            color: 'white',
            borderRadius: '5px',
            zIndex: 9999
        });
    
    $('body').append(loadingDiv);

    try {
        // Collect all phone numbers
        const allPhones = [];
        table.rows().every(function() {
            const phone = this.data()[0];
            if (phone) allPhones.push(phone.toString().trim());
        });

        if (allPhones.length === 0) {
            throw new Error('No phone numbers found in table');
        }

        // Process in larger batches
        const batchSize = 5000; // Increased batch size
        const batches = [];
        for (let i = 0; i < allPhones.length; i += batchSize) {
            batches.push(allPhones.slice(i, i + batchSize));
        }

        // Process all batches concurrently
        loadingDiv.text(`Requesting partner info for phones...`);
        
        const batchPromises = batches.map(async (batch, index) => { 
            try {
                const batchData = await getPartnerInfo(batch);
                loadingDiv.text(`Completed batch ${index + 1}/${batches.length}`);
                return batchData;
            } catch (error) {
                console.error(`Error in batch ${index + 1}:`, error);
                return {};
            }
        });

        // Wait for all batches to complete
        const batchResults = await Promise.all(batchPromises);
        
        // Merge all batch results
        const partnerInfo = Object.assign({}, ...batchResults);

        // Update table with all partner info at once
        let updatedCount = 0;
        table.rows().every(function() {
            const phone = this.data()[0].toString().trim();
            if (partnerInfo[phone]) {
                const partner = partnerInfo[phone].partner;
                const row = $(this.node());
                const partnerCell = row.find('td:last');
                partnerCell.text(partner);
                updatedCount++;
            }
        });

//         table.draw(false);
//         alert(`Partner information updated successfully:
// - Total records: ${allPhones.length}
// - Updated records: ${updatedCount}
// - Batches processed: ${batches.length}`);

    } catch (error) {
        console.error('Update failed:', error);
        alert(`Failed to update partner information: ${error.message}`);
    } finally {
        loadingDiv.remove();
    }
}

// Helper function to get partner info with timeout and retry
async function getPartnerInfo(phones) {
    const maxRetries = 3;
    const timeout = 30000; // 30 seconds timeout

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            const response = await fetch('/api/internal/get-partner-info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ phones }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            if (attempt === maxRetries) {
                throw error;
            }
            console.warn(`Attempt ${attempt} failed, retrying...`);
            await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
        }
    }
}

// Function for "All Fields" button
async function updateAllFields() {
    const table = $('#data-table').DataTable();
    const loadingDiv = $('<div>Sending partner data to database...</div>')
        .css({
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            padding: '20px',
            background: 'rgba(0,0,0,0.8)',
            color: 'white',
            borderRadius: '5px',
            zIndex: 9999
        });
    
    $('body').append(loadingDiv);

    try {
        // Collect all phone numbers and their current partner info
        const partnerData = {};
        table.rows().every(function() {
            const rowData = this.data();
            const phone = rowData[0];
            const partner = $(this.node()).find('td:last').text();
            if (phone && partner) {
                partnerData[phone] = { partner: partner };
            }
        });

        if (Object.keys(partnerData).length === 0) {
            throw new Error('No partner data found to update');
        }

        // Update database
        const result = await updateDatabase(partnerData);
        
//         alert(`Database update complete:
// - Records processed: ${Object.keys(partnerData).length}
// - Records updated: ${result.updatedCount}
// ${result.message}`);

    } catch (error) {
        console.error('Database update failed:', error);
        alert(`Failed to update database: ${error.message}`);
    } finally {
        loadingDiv.remove();
    }
}

// Helper function to update database
async function updateDatabase(partnerData) {
    try {
        console.log('Attempting to update database with partner data:', partnerData);
        
        const response = await fetch('/api/internal/update-partners', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ partnerData }),
            credentials: 'same-origin'
        });

        const result = await response.json();

        if (!response.ok) {
            console.error('Server Error:', result);
            throw new Error(result.message || 'Failed to update database');
        }

        // Log success information
        console.log('Database update successful:', result);
        if (result.updates) {
            console.log('Updated records:');
            Object.entries(result.updates).forEach(([phone, update]) => {
                console.log(`Phone: ${phone}`);
                console.log(`- Old partner: ${update.old_partner || 'None'}`);
                console.log(`- New partner: ${update.new_partner}`);
            });
        }

        return result;

    } catch (error) {
        console.error('Database Update Error:', error);
        alert(`Failed to update database: ${error.message}`);
        throw error;
    }
}

// Helper function to get partner information from API
async function getPartnerInfo(phones) {
    try {
        const API_ENDPOINT = '/api/internal/get-partners';
        
        console.log('Requesting partner info for phones:', phones);
        
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ phones }),
            credentials: 'same-origin'
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error Response:', {
                status: response.status,
                statusText: response.statusText,
                body: errorText
            });
            throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        // Transform the response data to match the expected format
        const transformedData = {};
        for (const item of data) {
            if (item.phone && item.partner) {
                transformedData[item.phone] = { partner: item.partner };
            }
        }
        
        console.log('Partner data received:', transformedData);
        return transformedData;

    } catch (error) {
        console.error('Partner API Error:', error);
        return phones.reduce((acc, phone) => {
            acc[phone] = { partner: 'Unknown' };
            return acc;
        }, {});
    }
}

// Add event listeners to buttons
document.addEventListener('DOMContentLoaded', function() {
    // Update Partner Info button
    document.querySelector('#updatePartnerBtn').addEventListener('click', updatePartnerInfo);
    
    // All Fields button
    document.querySelector('#allFieldsBtn').addEventListener('click', updateAllFields);
});

// Add event listener for partner filter
$('#partner-filter').on('change', function() {
    updateSummaryTable();
});

$(document).ready(function() {
    $('#check-duplicates-btn').on('click', function() {
        const table = $('#data-table').DataTable();
        const phoneNumbers = new Map();
        
        // Count duplicate phone numbers
        table.rows({ filter: 'applied' }).every(function() {
            const phone = this.data()[0];
            phoneNumbers.set(phone, (phoneNumbers.get(phone) || 0) + 1);
        });
        
        // Count numbers that appear more than once
        const duplicateCount = Array.from(phoneNumbers.values()).filter(count => count > 1).length;
        
        // Show popup with count
        const popup = document.getElementById('duplicate-popup');
        const message = document.getElementById('duplicate-count-message');
        message.textContent = `Found ${duplicateCount} phone numbers with duplicates.`;
        popup.style.display = 'block';
        
        // Handle OK button click
        popup.querySelector('.ok-button').onclick = function() {
            popup.style.display = 'none';
        };
        
        // Handle View Duplicates link click
        document.getElementById('view-duplicates-link').onclick = function(e) {
            e.preventDefault();
            popup.style.display = 'none';
            $('#duplicate-btn').click(); // Trigger the view duplicates modal
        };
        
        // Close popup when clicking outside
        window.onclick = function(event) {
            if (event.target == popup) {
                popup.style.display = 'none';
            }
        };
    });
});
</script>
</body> 
</html>
